using Loqui.Internal;
using Noggog;
using System.Text;
using System.Xml;
using System.Xml.Linq;
#if NETSTANDARD2_0 
using TaskCompletionSource = Noggog.TaskCompletionSource;
#else 
using TaskCompletionSource = System.Threading.Tasks.TaskCompletionSource;
#endif

namespace Loqui.Generation
{
    public abstract class ObjectGeneration
    {
        public string Name;
        public string Namespace;
        public string FullName => $"{Namespace}.{Name}";
        public abstract bool Abstract { get; }
        public DisabledLevel Disabled { get; set; }
        public bool GenerateClass { get; set; } = true;
        public bool GenerateEquals { get; set; } = true;
        public bool GenerateToString { get; set; } = true;
        public bool GenerateNthReflections { get; set; }
        public CtorPermissionLevel BasicCtorPermission { get; set; } = CtorPermissionLevel.@public;
        public abstract bool NullableDefault { get; }
        public LoquiInterfaceType SetterInterfaceTypeDefault;
        public LoquiInterfaceType GetterInterfaceTypeDefault;
        public bool ObjectCentralized;
        public PermissionLevel SetPermissionDefault;
        public RxBaseOption RxBaseOptionDefault;
        public bool DerivativeDefault;
        public int StartingIndex => HasLoquiBaseObject ? BaseClass.StartingIndex + BaseClass.IterateFields().Count() : 0;
        public int TotalFieldCount => StartingIndex + IterateFieldIndices().Count();
        public ClassGeneration BaseClass;
        public bool HasLoquiBaseObject => BaseClass != null;
        public bool SetBaseClass = true;
        public string NonLoquiBaseClass;
        public bool HasNonLoquiBaseObject => !string.IsNullOrWhiteSpace(NonLoquiBaseClass);
        public bool HasLoquiGenerics => Generics.Any((g) => g.Value.BaseObjectGeneration != null);
        public bool IsGeneric => Generics.Any();
        public bool HasNewGenerics => HasLoquiBaseObject && Generics.Any((g) => !BaseGenerics.ContainsKey(g.Key));
        public bool IsTopClass => BaseClass == null;
        public bool ForceInternalInterface = false;
        public InterfaceCollection Interfaces = new();
        public AttributeCollection Attributes = new();
        public Dictionary<string, GenericDefinition> Generics = new();
        public string EmptyGenerics(params MaskType[] maskType) => GetEmptyGenerics(maskType);
        public Dictionary<string, string> BaseGenerics = new();
        public virtual string NewOverride(Func<ObjectGeneration, bool> baseObjFilter = null, bool doIt = true) => " ";
        public virtual string ProtectedKeyword => "protected";
        public ushort? ID;
        public Guid GUID;
        public ushort Version = 0;
        public XElement Node;
        public ObjectKey Key => new(ProtoGen.Protocol, ID.Value, Version);
        public string FileName => $"{Name}{Constants.AutogeneratedMarkerString}.cs";
        public bool NeedsReflectionGeneration => GenerateNthReflections;
        public bool GenerateComplexCopySystems => false;

        public bool HasInternalGetInterface
        {
            get
            {
                if (ForceInternalInterface) return true;
                if (IterateFields().Any(f => f.InternalGetInterface)) return true;
                return BaseClassTrail().Any(b => b.HasInternalGetInterface);
            }
        }
        public bool HasInternalSetInterface
        {
            get
            {
                if (ForceInternalInterface) return true;
                if (IterateFields().Any(f => f.InternalSetInterface)) return true;
                return BaseClassTrail().Any(b => b.HasInternalSetInterface);
            }
        }

        // String properties
        public string ObjectName => $"{Name}{GetGenericTypes(MaskType.Normal)}";
        public string ExtName => $"{Name}Ext";
        public string RegistrationName => $"{Name}_Registration";
        public string BaseGenericTypes => GenerateGenericClause(BaseGenerics.Select((g) => g.Value));
        public string BaseClassName => $"{BaseClass.Name}{BaseGenericTypes}";
        public string FieldIndexName => $"{Name}_FieldIndex";
        public string ProtocolDefinitionName => $"{ProtoGen.ProtocolDefinitionName}";
        public string CommonNameAdditions(LoquiInterfaceType loquiType, params MaskType[] types)
        {
            List<string> additions = new List<string>();
            switch (loquiType)
            {
                case LoquiInterfaceType.Direct:
                    additions.Add("Direct");
                    break;
                case LoquiInterfaceType.ISetter:
                    additions.Add("Setter");
                    break;
                case LoquiInterfaceType.IGetter:
                    break;
                default:
                    throw new NotImplementedException();
            }
            foreach (var mask in types.OrderBy(e => (int)e))
            {
                switch (mask)
                {
                    case MaskType.Normal:
                    case MaskType.NormalGetter:
                        break;
                    case MaskType.Error:
                        additions.Add(nameof(MaskType.Error));
                        break;
                    case MaskType.Copy:
                        additions.Add(nameof(MaskType.Copy));
                        break;
                    case MaskType.Translation:
                        additions.Add(nameof(MaskType.Translation));
                        break;
                    default:
                        throw new NotImplementedException();
                }
            }
            return string.Join(string.Empty, additions);
        }
        public string CommonClassName(LoquiInterfaceType interfaceType, params MaskType[] types) => $"{Name}{CommonNameAdditions(interfaceType, types)}Common";
        public string CommonClass(LoquiInterfaceType interfaceType, CommonGenerics commonGen, params MaskType[] types) => $"{CommonClassName(interfaceType, types)}{(commonGen == CommonGenerics.Class ? GetGenericTypes(types.Length == 0 ? new MaskType[] { MaskType.Normal } : types) : null)}";
        public string CommonClass(LoquiInterfaceType interfaceType, CommonGenerics commonGen, GenericSpecification spec, params MaskType[] types) => $"{CommonClassName(interfaceType, types)}{(commonGen == CommonGenerics.Class ? GetGenericTypes(types.Length == 0 ? new MaskType[] { MaskType.Normal } : types, spec) : null)}";
        public string CommonClassInstance(Accessor accessor, LoquiInterfaceType interfaceType, CommonGenerics commonGen, params MaskType[] types) =>
            $"(({CommonClass(interfaceType, commonGen, types)})(({Interface(types, getter: true, internalInterface: false)}){accessor}).Common{CommonNameAdditions(interfaceType, types)}Instance({(commonGen == CommonGenerics.Class ? string.Join(", ", Generics.Select(x => $"typeof({x.Key})")) : null)})!)";

        public string CommonClassSpeccedInstance(Accessor accessor, LoquiInterfaceType interfaceType,
            CommonGenerics commonGen, GenericSpecification specs, params MaskType[] types)
        {
            return 
                $"(({CommonClass(interfaceType, commonGen, specs, types)})(({Interface(types, getter: true, internalInterface: false, specification: specs)}){accessor}).Common{CommonNameAdditions(interfaceType, types)}Instance({(commonGen == CommonGenerics.Class ? string.Join(", ", Generics.Select(x => $"typeof({specs.Swap(x.Key)})")) : null)})!)";
        }
        public string MixInClassName => $"{Name}MixIn";

        public DirectoryPath TargetDir { get; private set; }
        public FilePath SourceXMLFile { get; private set; }
        protected LoquiGenerator gen;
        public ProtocolGeneration ProtoGen;
        public HashSet<string> RequiredNamespaces = new();
        public ExtendedList<GenerationInterface> GenerationInterfaces = new();
        public ExtendedList<TypeGeneration> Fields = new();
        public IEnumerable<TypeGeneration> AllFields => HasLoquiBaseObject ? Fields.And(BaseClass?.AllFields) : Fields;
        public Dictionary<FilePath, ProjItemType> GeneratedFiles = new();
        public Dictionary<object, object> CustomData = new();

        // Task Coordinators
        protected TaskCompletionSource<ExtendedList<ObjectGeneration>> _directlyInheritingObjectsTcs = new TaskCompletionSource<ExtendedList<ObjectGeneration>>();
        protected Task<ExtendedList<ObjectGeneration>> _directlyInheritingObjects => _directlyInheritingObjectsTcs.Task;
        public async Task<IEnumerable<ObjectGeneration>> InheritingObjects()
        {
            List<ObjectGeneration> ret = new List<ObjectGeneration>();
            var objs = await _directlyInheritingObjects;
            ret.AddRange(objs);
            ret.AddRange((await Task.WhenAll(
                objs.Select(async (o) => await o.InheritingObjects()))).SelectMany((i) => i));
            return ret;
        }
        public TaskCompletionSource LoadingCompleteTask = new TaskCompletionSource();
        protected TaskCompletionSource WiredBaseClassTCS = new TaskCompletionSource();
        public Task WiredBaseClassTask => WiredBaseClassTCS.Task;
        protected TaskCompletionSource fieldCtorsGenerated = new TaskCompletionSource();
        public Task FieldCtorsGeneratedSignal => fieldCtorsGenerated.Task;
        private TaskCompletionSource<MaskTypeSetCollection> _MaskTypeSetCollection = new TaskCompletionSource<MaskTypeSetCollection>();
        public Task<MaskTypeSetCollection> MaskTypeSetCollection => _MaskTypeSetCollection.Task;

        public CommentCollection Comments;

        public ObjectGeneration(LoquiGenerator gen, ProtocolGeneration protoGen, FilePath sourceFile)
        {
            this.gen = gen;
            ProtoGen = protoGen;
            TargetDir = sourceFile.Directory ?? throw new ArgumentException();
            SourceXMLFile = sourceFile;
            SetterInterfaceTypeDefault = ProtoGen.SetterInterfaceTypeDefault;
            GetterInterfaceTypeDefault = ProtoGen.GetterInterfaceTypeDefault;
            SetPermissionDefault = ProtoGen.SetPermissionDefault;
            RxBaseOptionDefault = ProtoGen.RxBaseOptionDefault;
            DerivativeDefault = ProtoGen.DerivativeDefault;
            GenerateNthReflections = ProtoGen.NthReflectionDefault;
            GenerateToString = ProtoGen.ToStringDefault;
            Disabled = DisabledLevel.Enabled;

            RequiredNamespaces.Add("System");
            RequiredNamespaces.Add("System.Collections");
            RequiredNamespaces.Add("System.Collections.Generic");
            RequiredNamespaces.Add("System.Linq");
            RequiredNamespaces.Add("System.Text");
            RequiredNamespaces.Add("Loqui");
            RequiredNamespaces.Add("Loqui.Internal");
            RequiredNamespaces.Add("Noggog");
            RequiredNamespaces.Add("System.Diagnostics");
        }

        public virtual async Task Load()
        {
            Node.TransferAttribute<bool>(Constants.GENERATE_CLASS, (i) => GenerateClass = i);
            Node.TransferAttribute<bool>(Constants.GENERATE_EQUALS, (i) => GenerateEquals = i);
            Node.TransferAttribute<bool>(Constants.GENERATE_TO_STRING, (i) => GenerateToString = i);
            Node.TransferAttribute<CtorPermissionLevel>(Constants.CTOR_PERMISSION, (i) => BasicCtorPermission = i);
            Node.TransferAttribute<ushort>(Constants.VERSION, (i) => Version = i);
            Node.TransferAttribute<bool>(Constants.FORCE_INTERNAL_INTERFACE, (i) => ForceInternalInterface = i);
            Node.TransferAttribute<LoquiInterfaceType>(Constants.SET_INTERFACE_TYPE_DEFAULT, (i) => SetterInterfaceTypeDefault = i);
            Node.TransferAttribute<LoquiInterfaceType>(Constants.GET_INTERFACE_TYPE_DEFAULT, (i) => GetterInterfaceTypeDefault = i);
            Node.TransferAttribute<PermissionLevel>(Constants.SET_PERMISSION_DEFAULT, (i) => SetPermissionDefault = i);
            Node.TransferAttribute<bool>(Constants.DERIVATIVE_DEFAULT, (i) => DerivativeDefault = i);
            Node.TransferAttribute<DisabledLevel>(Constants.DISABLE, (i) => Disabled = i);
            Node.TransferAttribute<bool>(Constants.SET_BASE_CLASS, i => SetBaseClass = i);

            var namespacesNode = Node.Element(XName.Get(Constants.NAMESPACES, LoquiGenerator.Namespace));
            if (namespacesNode != null)
            {
                foreach (var node in namespacesNode.Elements())
                {
                    if (!string.IsNullOrWhiteSpace(node.Value))
                    {
                        RequiredNamespaces.Add(node.Value);
                    }
                }
            }

            foreach (var genNode in Node.Elements(XName.Get(Constants.GENERIC, LoquiGenerator.Namespace)))
            {
                var generic = new GenericDefinition();
                generic.Load(genNode);
                Generics[generic.Name] = generic;
            }

            foreach (var interfNode in Node.Elements(XName.Get(Constants.INTERFACE, LoquiGenerator.Namespace)))
            {
                Interfaces.Add(interfNode.GetAttribute<LoquiInterfaceDefinitionType>(Constants.TYPE, LoquiInterfaceDefinitionType.Dual), interfNode.Value);
            }

            var fieldsNode = Node.Element(XName.Get(Constants.FIELDS, LoquiGenerator.Namespace));
            if (fieldsNode != null)
            {
                foreach (var fieldNode in fieldsNode.Elements())
                {
                    await LoadField(
                        fieldNode,
                        requireName: true,
                        add: true);
                }
            }

            foreach (var interf in GenerationInterfaces)
            {
                interf.Modify(this);
            }

            var directlyInheritingObjs = new ExtendedList<ObjectGeneration>();
            await Task.WhenAll(
                ProtoGen.Gen.ObjectGenerations.Select(
                    async (obj) =>
                    {
                        await obj.WiredBaseClassTask;
                        if (!obj.HasLoquiBaseObject) return;
                        if (!ReferenceEquals(obj.BaseClass, this)) return;
                        directlyInheritingObjs.Add(obj);
                    }));
            _directlyInheritingObjectsTcs.SetResult(directlyInheritingObjs);

            if (directlyInheritingObjs.Count > 0)
            {
                (Comments ??= new()).Comments.Summary.AppendLine($"Implemented by: [{string.Join(", ", directlyInheritingObjs.Select(x => x.ObjectName))}]");
            }

            await Task.WhenAll(
                gen.GenerationModules.Select((m) => m.LoadWrapup(this)));
        }

        public async Task<TryGet<TypeGeneration>> LoadField(XElement fieldNode, bool requireName, bool throwException = true, bool setDefaults = true, bool add = false)
        {
            if (fieldNode.NodeType == XmlNodeType.Comment)
            {
                return TryGet<TypeGeneration>.Failure;
            }

            if (!gen.TryGetTypeGeneration(fieldNode.Name.LocalName, out var typeGen))
            {
                if (throwException)
                {
                    throw new ArgumentException($"Unknown field type: {fieldNode.Name.LocalName}");
                }
                else
                {
                    return TryGet<TypeGeneration>.Failure;
                }
            }

            typeGen.SetObjectGeneration(this, setDefaults: setDefaults);
            await typeGen.Load(fieldNode, requireName);
            await LoadField(typeGen, fieldNode, add: add);
            return TryGet<TypeGeneration>.Succeed(typeGen);
        }

        public async Task LoadField(TypeGeneration typeGen, XElement fieldNode = null, bool add = true)
        {
            if (Fields.Any((f) => f.Name?.Equals(typeGen.Name) ?? false))
            {
                throw new ArgumentException($"Cannot have two fields with the same name: {typeGen.Name}");
            }
            if (add)
            {
                typeGen.SetObjectGeneration(this, setDefaults: true);
                Fields.Add(typeGen);
            }
            await Task.WhenAll(gen.GenerationModules.Select((m) => m.PostFieldLoad(this, typeGen, fieldNode)));
            typeGen.FinalizeField();
        }

        public static void AddAutogenerationComment(StructuredStringBuilder sb)
        {
            sb.AppendLine("/*");
            sb.AppendLine(" * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * ");
            sb.AppendLine(" * Autogenerated by Loqui.  Do not manually change.");
            sb.AppendLine(" * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * ");
            sb.AppendLine("*/");
        }

        public async Task Generate()
        {
            if (Disabled != DisabledLevel.Enabled) return;
            StructuredStringBuilder sb = new StructuredStringBuilder();
            AddAutogenerationComment(sb);

            await AddNamespaces(sb);
            sb.AppendLine("#nullable enable");

            using (new NamespaceWrapper(sb, Namespace, fileScoped: false))
            {
                if (GenerateClass)
                {
                    await GenerateClassFile(sb);
                }

                await GenerateInterfaces(sb);

                await GenerateMixIns(sb);
            }
            sb.AppendLine();

            using (new NamespaceWrapper(sb, Namespace, fileScoped: false))
            {
                GenerateEnumIndex(sb);
                await GenerateRegistration(sb);
                await GenerateCommon(sb);
                GenerateLoquiInterfaces(sb);
            }
            sb.AppendLine();

            using (new NamespaceWrapper(sb, Namespace, fileScoped: false))
            {
                sb.AppendLine($"public partial class {ObjectName}");
                using (sb.CurlyBrace())
                {
                    await GenerateRouting(sb, getterOnly: false);
                }
            }
            sb.AppendLine();

            await GenerateTranslations(sb);
            await GenerateNonGenericClass(sb);

            var fileName = Path.Combine(TargetDir.Path, FileName);
            var file = new FileInfo(fileName);
            GeneratedFiles[Path.GetFullPath(fileName)] = ProjItemType.Compile;
            sb.Generate(file);
            if (!gen.GeneratedFiles.Add(fileName))
            {
                throw new ArgumentException();
            }
        }

        public bool HasKeyField()
        {
            foreach (var field in IterateFields())
            {
                if (field.KeyField) return true;
            }
            if (HasLoquiBaseObject)
            {
                return BaseClass.HasKeyField();
            }
            return false;
        }

        public static string GenerateGenericClause(params string[] keys)
        {
            return GenerateGenericClause((IEnumerable<string>)keys);
        }

        public static string GenerateGenericClause(params IEnumerable<string>[] keys)
        {
            return GenerateGenericClause(keys.SelectMany((i) => i));
        }

        public static string GenerateGenericClause(IEnumerable<string> keys)
        {
            if (!keys.Any()) return string.Empty;
            return $"<{string.Join(", ", keys)}>";
        }

        public IEnumerable<string> GenerateWhereClauses(LoquiInterfaceType type, IEnumerable<KeyValuePair<string, GenericDefinition>> defs = null, string nickname = null)
        {
            foreach (var gen in (defs ?? Generics))
            {
                List<string> wheres = new List<string>();
                if (gen.Value.MustBeClass
                    && (gen.Value.BaseObjectGeneration == null || type != LoquiInterfaceType.Direct))
                {
                    wheres.Add("class");
                }
                wheres.AddRange(gen.Value.GetWheres(type));
                if (gen.Value.Loqui && gen.Value.BaseObjectGeneration == null)
                {
                    switch (type)
                    {
                        case LoquiInterfaceType.IGetter:
                            wheres.Add($"{nameof(ILoquiObject)}<{gen.Key}>");
                            break;
                        case LoquiInterfaceType.Direct:
                        case LoquiInterfaceType.ISetter:
                            wheres.Add($"{nameof(ILoquiObjectSetter)}<{gen.Key}>");
                            if (gen.Value.Loqui)
                            {
                                wheres.Add("TGetter");
                            }
                            break;
                        default:
                            throw new NotImplementedException();
                    }
                }
                if (wheres.Count > 0)
                {
                    yield return $"where {gen.Key}{nickname} : {string.Join(", ", wheres)}";
                }
            }
        }

        public async Task GenerateForField(StructuredStringBuilder sb, TypeGeneration field)
        {
            if (!field.GenerateClassMembers) return;
            using (new RegionWrapper(sb, field.Name) { AppendExtraLine = false })
            {
                await field.GenerateForClass(sb);
                foreach (var module in gen.GenerationModules)
                {
                    await module.GenerateInField(this, field, sb, LoquiInterfaceType.Direct);
                }
            }
        }

        private async Task GenerateClassFile(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Class"))
            {
                Comments?.Apply(sb, LoquiInterfaceType.Direct);
                await GenerateClassLine(sb);

                using (new DepthWrapper(sb))
                {
                    foreach (var where in GenerateWhereClauses(LoquiInterfaceType.ISetter, Generics))
                    {
                        sb.AppendLine(where);
                    }
                }

                using (sb.CurlyBrace())
                {
                    await GenerateCtor(sb);

                    await GenerateStaticCtor(sb);
                    // Generate fields
                    foreach (var field in IterateFieldIndices())
                    {
                        await GenerateForField(sb, field.Field);
                    }
                    sb.AppendLine();

                    if (GenerateNthReflections)
                    {
                        await GenerateLoquiReflectionGetterInterface(sb);

                        await GenerateLoquiReflectionSetterInterface(sb);
                    }

                    await GenerateToStringCode(sb);

                    GenerateEqualsSection(sb);

                    await GenerateModules(sb);

                    GenerateGetterInterfaceImplementations(sb);

                    GenerateInterfacesInClass(sb);

                    GenerateClear(sb);

                    await GenerateCreateNew(sb);

                    if (GenerateNthReflections)
                    {
                        await GenerateSetNthObject(sb);

                        GenerateGenericCreate(sb);
                    }
                }
            }
        }

        public async Task GenerateInitializer(StructuredStringBuilder sb)
        {
            foreach (var loqui in Fields
                .WhereCastable<TypeGeneration, LoquiType>()
                .Where(l => l.ThisConstruction))
            {
                if (loqui.Singleton)
                {
                    sb.AppendLine($"{loqui.SingletonObjectName} = new {loqui.DirectTypeName}(this);");
                }
                else
                {
                    sb.AppendLine($"_{loqui.Name} = new {loqui.DirectTypeName}(this);");
                }
            }
        }

        private async Task GenerateInterfaces(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Interface"))
            {
                await GenerateSetterInterface(sb);
                await GenerateGetterInterface(sb);
            }
        }

        protected virtual async Task GenerateMixIns(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Common MixIn"))
            {
                using (var args = new ClassWrapper(sb, $"{MixInClassName}"))
                {
                    args.Static = true;
                    args.Partial = true;
                }
                using (sb.CurlyBrace())
                {
                    await GenerateClearMixIn(sb);
                    await GenerateGetEqualsMaskMixIn(sb);
                    await GenerateToStringMixIn(sb);
                    await GenerateEqualsMixIn(sb);
                    if (GenerateComplexCopySystems)
                    {
                        await GenerateCopyInExtensions(sb);
                        GenerateCopyMixIn(sb);
                    }
                    await GenerateDeepCopyInExtensions(sb);
                    GenerateDeepCopyMixIn(sb);

                    // Modules might add some content
                    foreach (var mod in gen.GenerationModules)
                    {
                        using (new RegionWrapper(sb, mod.RegionString))
                        {
                            await mod.GenerateInCommonMixin(this, sb);
                        }
                    }
                }
            }
        }

        protected virtual async Task GenerateSetterInterface(StructuredStringBuilder sb)
        {
            var interfaceLine = Interface(
                genericTypes: GenerateGenericClause(Generics.Select((g) => g.Value.SetterName)),
                getter: false,
                internalInterface: false);

            var interfaceType = LoquiInterfaceType.ISetter;

            // Interface
            Comments?.Apply(sb, interfaceType);
            using (var args = new ClassWrapper(sb, interfaceLine))
            {
                args.Type = ClassWrapper.ObjectType.@interface;
                args.Partial = true;
                args.Interfaces.Add(Interface(getter: true, internalInterface: true));
                if (HasLoquiBaseObject)
                {
                    args.Interfaces.Add(BaseClass.Interface(BaseGenericTypes, internalInterface: true));
                }
                args.Interfaces.Add(Interfaces.Get(interfaceType));
                args.Interfaces.Add($"{nameof(ILoquiObjectSetter)}<{Interface(internalInterface: true)}>");
                args.Interfaces.Add(await GetApplicableInterfaces(interfaceType).ToListAsync());
                args.Wheres.AddRange(GenerateWhereClauses(interfaceType, Generics));
                args.Attributes.AddRange(Attributes.Get(LoquiInterfaceType.ISetter));
                
            }
            using (sb.CurlyBrace())
            {
                foreach (var field in IterateFields())
                {
                    if (!field.GenerateInterfaceMembers) continue;
                    field.GenerateForInterface(sb, getter: false, internalInterface: false);
                }

                foreach (var mod in gen.GenerationModules)
                {
                    using (new RegionWrapper(sb, mod.RegionString))
                    {
                        await mod.GenerateInInterface(this, sb, internalInterface: false, getter: false);
                    }
                }
            }
            sb.AppendLine();

            if (HasInternalSetInterface)
            {
                // Internal Interface
                using (var args = new ClassWrapper(sb, Interface(internalInterface: true)))
                {
                    args.Type = ClassWrapper.ObjectType.@interface;
                    args.Partial = true;
                    args.BaseClass = BaseClassTrail().FirstOrDefault(b => b.HasInternalSetInterface)?.Interface(internalInterface: true);
                    args.Interfaces.Add(Interface(internalInterface: false));
                    args.Interfaces.Add(Interface(getter: true, internalInterface: true));
                    args.Wheres.AddRange(GenerateWhereClauses(interfaceType, Generics));
                    args.Attributes.AddRange(Attributes.Get(LoquiInterfaceType.ISetter));
                }
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (!field.GenerateInterfaceMembers) continue;
                        field.GenerateForInterface(sb, getter: false, internalInterface: true);
                    }

                    foreach (var mod in gen.GenerationModules)
                    {
                        using (new RegionWrapper(sb, mod.RegionString))
                        {
                            await mod.GenerateInInterface(this, sb, internalInterface: true, getter: false);
                        }
                    }
                }
                sb.AppendLine();
            }
        }

        protected virtual async Task GenerateGetterInterface(StructuredStringBuilder sb)
        {
            var interfaceLine = Interface(
                genericTypes: GenerateGenericClause(Generics.Select((g) => g.Value.GetterName)),
                getter: true,
                internalInterface: false);

            var interfaceType = LoquiInterfaceType.IGetter;

            // Getter
            Comments?.Apply(sb, interfaceType);
            using (var args = new ClassWrapper(sb, interfaceLine))
            {
                args.Type = ClassWrapper.ObjectType.@interface;
                args.Partial = true;
                args.BaseClass = (HasLoquiBaseObject ? BaseClass.Interface(BaseGenericTypes, getter: true, internalInterface: false) : nameof(ILoquiObject));
                args.Interfaces.Add(Interfaces.Get(interfaceType));
                args.Interfaces.Add($"{nameof(ILoquiObject)}<{Interface(getter: true, internalInterface: true)}>");
                args.Interfaces.Add(await GetApplicableInterfaces(interfaceType).ToListAsync());
                args.Wheres.AddRange(GenerateWhereClauses(interfaceType, Generics));
                args.Attributes.AddRange(Attributes.Get(LoquiInterfaceType.IGetter));
            }

            using (sb.CurlyBrace())
            {
                if (IsTopClass)
                {
                    sb.AppendLine("[System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Never)]");
                    sb.AppendLine($"object Common{CommonNameAdditions(interfaceType)}Instance({string.Join(", ", Generics.Select((_, i) => $"Type type{i}"))});");
                    sb.AppendLine("[System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Never)]");
                    sb.AppendLine($"object? Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal)}Instance({string.Join(", ", Generics.Select((_, i) => $"Type type{i}"))});");
                    if (GenerateComplexCopySystems)
                    {
                        sb.AppendLine("[System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Never)]");
                        using (var args = new FunctionWrapper(sb,
                            $"object Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{GetGenericTypes(MaskType.Copy)}"))
                        {
                            args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Copy));
                            args.SemiColon = true;
                        }
                    }
                    sb.AppendLine("[System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Never)]");
                    sb.AppendLine($"object Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation)}Instance();");
                }
                sb.AppendLine($"static{NewOverride()}{nameof(ILoquiRegistration)} StaticRegistration => {RegistrationName}.Instance;");
                foreach (var field in IterateFields())
                {
                    if (!field.GenerateInterfaceMembers) continue;
                    using (new RegionWrapper(sb, field.Name)
                    {
                        AppendExtraLine = false,
                        SkipIfOnlyOneLine = true
                    })
                    {
                        field.GenerateForInterface(sb, getter: true, internalInterface: false);
                    }
                }
                sb.AppendLine();

                foreach (var mod in gen.GenerationModules)
                {
                    using (new RegionWrapper(sb, mod.RegionString))
                    {
                        await mod.GenerateInInterface(this, sb, internalInterface: false, getter: true);
                    }
                }
            }
            sb.AppendLine();

            if (HasInternalGetInterface)
            {
                // Internal Getter
                interfaceLine = Interface(
                    genericTypes: GenerateGenericClause(Generics.Select((g) => g.Value.GetterName)),
                    getter: true,
                    internalInterface: true);
                using (var args = new ClassWrapper(sb, interfaceLine))
                {
                    args.Type = ClassWrapper.ObjectType.@interface;
                    args.Partial = true;
                    args.BaseClass = BaseClassTrail().FirstOrDefault()?.Interface(internalInterface: true, getter: true);
                    args.Interfaces.Add(Interface(getter: true, internalInterface: false));
                    args.Wheres.AddRange(GenerateWhereClauses(interfaceType, Generics));
                    args.Attributes.AddRange(Attributes.Get(LoquiInterfaceType.IGetter));
                }
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (!field.InternalGetInterface) continue;
                        if (!field.GenerateInterfaceMembers) continue;
                        using (new RegionWrapper(sb, field.Name) { AppendExtraLine = false })
                        {
                            field.GenerateForInterface(sb, getter: true, internalInterface: true);
                        }
                    }
                    sb.AppendLine();

                    foreach (var mod in gen.GenerationModules)
                    {
                        using (new RegionWrapper(sb, mod.RegionString))
                        {
                            await mod.GenerateInInterface(this, sb, internalInterface: true, getter: true);
                        }
                    }
                    sb.AppendLine();
                }
            }
        }

        protected void GenerateEnumIndex(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Field Index"))
            {
                sb.AppendLine($"internal enum {FieldIndexName}");
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFieldIndices(includeBaseClass: true))
                    {
                        if (!field.Field.IntegrateField || !field.Field.Enabled) continue;
                        sb.AppendLine($"{field.Field.Name} = {field.PublicIndex},");
                    }
                }
            }
        }

        protected async Task GenerateRegistration(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Registration"))
            {
                using (var args = new ClassWrapper(sb, RegistrationName))
                {
                    args.Interfaces.Add(nameof(ILoquiRegistration));
                    args.Partial = true;
                    args.Public = PermissionLevel.@internal;
                }
                using (sb.CurlyBrace())
                {
                    sb.AppendLine($"public static readonly {RegistrationName} Instance = new {RegistrationName}();");
                    sb.AppendLine();

                    sb.AppendLine($"public static ProtocolKey ProtocolKey => {ProtocolDefinitionName}.ProtocolKey;");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly ObjectKey ObjectKey = new ObjectKey(");
                    using (new DepthWrapper(sb))
                    {
                        sb.AppendLine($"protocolKey: {ProtocolDefinitionName}.ProtocolKey,");
                        sb.AppendLine($"msgID: {ID},");
                        sb.AppendLine($"version: {Version});");
                    }
                    sb.AppendLine();

                    sb.AppendLine($"public const string GUID = \"{GUID}\";");
                    sb.AppendLine();

                    sb.AppendLine($"public const ushort AdditionalFieldCount = {IterateFields().Count()};");
                    sb.AppendLine();

                    sb.AppendLine($"public const ushort FieldCount = {TotalFieldCount};");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type MaskType = typeof({GetMaskString("")});");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type ErrorMaskType = typeof({Mask_Unspecified(MaskType.Error)});");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type ClassType = typeof({Name}{EmptyGenerics()});");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type GetterType = typeof({InterfaceNoGenerics(getter: true)}{EmptyGenerics()});");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type? InternalGetterType = {(HasInternalGetInterface ? $"typeof({InterfaceNoGenerics(getter: true, internalInterface: true)}{EmptyGenerics()})" : "null")};");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type SetterType = typeof({InterfaceNoGenerics()}{EmptyGenerics()});");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type? InternalSetterType = {(HasInternalSetInterface ? $"typeof({InterfaceNoGenerics(internalInterface: true)}{EmptyGenerics()})" : "null")};");
                    sb.AppendLine();

                    sb.AppendLine($"public const string FullName = \"{FullName}\";");
                    sb.AppendLine();

                    sb.AppendLine($"public const string Name = \"{Name}\";");
                    sb.AppendLine();

                    sb.AppendLine($"public const string Namespace = \"{Namespace}\";");
                    sb.AppendLine();

                    sb.AppendLine($"public const byte GenericCount = {Generics.Count};");
                    sb.AppendLine();

                    sb.AppendLine($"public static readonly Type? GenericRegistrationType = {(Generics.Count > 0 ? $"typeof({RegistrationName}{EmptyGenerics()})" : "null")};");
                    sb.AppendLine();

                    if (GenerateNthReflections)
                    {
                        GenerateGetNameIndex(sb);

                        GenerateNthObjectIsEnumerable(sb);

                        GenerateNthObjectIsLoqui(sb);

                        GenerateGetNthIsSingleton(sb);

                        GenerateGetNthName(sb);

                        GenerateNthObjectIsDerivative(sb);

                        GenerateIsProtected(sb);

                        if (Generics.Count == 0)
                        {
                            GenerateGetNthType(sb, false);
                        }
                        else
                        {
                            sb.AppendLine("public static Type GetNthType(ushort index) => throw new ArgumentException(\"Cannot get nth type for a generic object here.  Use generic registration instead.\");");
                            sb.AppendLine();
                        }
                    }

                    foreach (var mod in gen.GenerationModules)
                    {
                        await mod.GenerateInRegistration(this, sb);
                    }

                    foreach (var field in Fields)
                    {
                        field.GenerateInRegistration(sb);
                    }

                    using (new RegionWrapper(sb, "Interface"))
                    {
                        sb.AppendLine($"ProtocolKey ILoquiRegistration.ProtocolKey => ProtocolKey;");
                        sb.AppendLine($"ObjectKey ILoquiRegistration.ObjectKey => ObjectKey;");
                        sb.AppendLine($"string ILoquiRegistration.GUID => GUID;");
                        sb.AppendLine($"ushort ILoquiRegistration.FieldCount => FieldCount;");
                        sb.AppendLine($"ushort ILoquiRegistration.AdditionalFieldCount => AdditionalFieldCount;");
                        sb.AppendLine($"Type ILoquiRegistration.MaskType => MaskType;");
                        sb.AppendLine($"Type ILoquiRegistration.ErrorMaskType => ErrorMaskType;");
                        sb.AppendLine($"Type ILoquiRegistration.ClassType => ClassType;");
                        sb.AppendLine($"Type ILoquiRegistration.SetterType => SetterType;");
                        sb.AppendLine($"Type? ILoquiRegistration.InternalSetterType => InternalSetterType;");
                        sb.AppendLine($"Type ILoquiRegistration.GetterType => GetterType;");
                        sb.AppendLine($"Type? ILoquiRegistration.InternalGetterType => InternalGetterType;");
                        sb.AppendLine($"string ILoquiRegistration.FullName => FullName;");
                        sb.AppendLine($"string ILoquiRegistration.Name => Name;");
                        sb.AppendLine($"string ILoquiRegistration.Namespace => Namespace;");
                        sb.AppendLine($"byte ILoquiRegistration.GenericCount => GenericCount;");
                        sb.AppendLine($"Type? ILoquiRegistration.GenericRegistrationType => GenericRegistrationType;");
                        if (GenerateNthReflections)
                        {
                            sb.AppendLine($"ushort? ILoquiRegistration.GetNameIndex(StringCaseAgnostic name) => GetNameIndex(name);");
                            sb.AppendLine($"bool ILoquiRegistration.GetNthIsEnumerable(ushort index) => GetNthIsEnumerable(index);");
                            sb.AppendLine($"bool ILoquiRegistration.GetNthIsLoqui(ushort index) => GetNthIsLoqui(index);");
                            sb.AppendLine($"bool ILoquiRegistration.GetNthIsSingleton(ushort index) => GetNthIsSingleton(index);");
                            sb.AppendLine($"string ILoquiRegistration.GetNthName(ushort index) => GetNthName(index);");
                            sb.AppendLine($"bool ILoquiRegistration.IsNthDerivative(ushort index) => IsNthDerivative(index);");
                            sb.AppendLine($"bool ILoquiRegistration.IsProtected(ushort index) => IsProtected(index);");
                            sb.AppendLine($"Type ILoquiRegistration.GetNthType(ushort index) => GetNthType(index);");
                        }
                        else
                        {
                            sb.AppendLine($"ushort? ILoquiRegistration.GetNameIndex(StringCaseAgnostic name) => throw new NotImplementedException();");
                            sb.AppendLine($"bool ILoquiRegistration.GetNthIsEnumerable(ushort index) => throw new NotImplementedException();");
                            sb.AppendLine($"bool ILoquiRegistration.GetNthIsLoqui(ushort index) => throw new NotImplementedException();");
                            sb.AppendLine($"bool ILoquiRegistration.GetNthIsSingleton(ushort index) => throw new NotImplementedException();");
                            sb.AppendLine($"string ILoquiRegistration.GetNthName(ushort index) => throw new NotImplementedException();");
                            sb.AppendLine($"bool ILoquiRegistration.IsNthDerivative(ushort index) => throw new NotImplementedException();");
                            sb.AppendLine($"bool ILoquiRegistration.IsProtected(ushort index) => throw new NotImplementedException();");
                            sb.AppendLine($"Type ILoquiRegistration.GetNthType(ushort index) => throw new NotImplementedException();");
                        }
                    }
                }

                if (Generics.Count > 0)
                {
                    sb.AppendLine();
                    using (var args = new ClassWrapper(sb, $"{RegistrationName}{GetGenericTypes(MaskType.Normal)}"))
                    {
                        args.Public = PermissionLevel.@internal;
                        args.Interfaces.Add(RegistrationName);
                        args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.Direct, Generics));
                    }
                    using (sb.CurlyBrace())
                    {
                        sb.AppendLine($"public static readonly {RegistrationName}{GetGenericTypes(MaskType.Normal)} GenericInstance = new {RegistrationName}{GetGenericTypes(MaskType.Normal)}();");
                        sb.AppendLine();

                        if (GenerateNthReflections)
                        {
                            GenerateGetNthType(sb, true);
                        }
                    }
                }
            }
        }

        private async Task GenerateCommon(StructuredStringBuilder sb)
        {
            MaskTypeSetCollection activeMaskCollections = new MaskTypeSetCollection();
            using (new RegionWrapper(sb, "Common"))
            {
                await GenerateCommonClass(sb, activeMaskCollections, LoquiInterfaceType.ISetter, CommonGenerics.Class, MaskType.Normal);
                await GenerateCommonClass(sb, activeMaskCollections, LoquiInterfaceType.IGetter, CommonGenerics.Class, MaskType.Normal);
                await GenerateCommonClass(sb, activeMaskCollections, LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Copy);
                await GenerateCommonClass(sb, activeMaskCollections, LoquiInterfaceType.IGetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Copy);
                await GenerateCommonClass(sb, activeMaskCollections, LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation);
            }
            _MaskTypeSetCollection.SetResult(activeMaskCollections);
        }

        private async Task GenerateCommonClass(StructuredStringBuilder sb, MaskTypeSetCollection activeMaskCollections, LoquiInterfaceType interfaceType, CommonGenerics commonGen, params MaskType[] maskTypes)
        {
            bool acceptAll = false;
            var maskTypeCol = new MaskTypeSet(interfaceType, maskTypes, commonGen: commonGen, acceptAll: acceptAll);
            if (acceptAll && !maskTypeCol.IsMainSet) return;

            StructuredStringBuilder subGen = new StructuredStringBuilder();

            if (GenerateComplexCopySystems)
            {
                GenerateCopyInCommon(subGen, maskTypeCol);
            }

            GenerateDeepCopyInCommon(subGen, maskTypeCol);

            if (GenerateNthReflections)
            {
                GenerateUnsetNthObject(subGen, maskTypeCol);

                GenerateGetNthObject(subGen, maskTypeCol);
            }

            await GenerateClearCommon(subGen, maskTypeCol);

            GenerateGetEqualsMask(subGen, maskTypeCol);

            GenerateCommonToString(subGen, maskTypeCol);

            GenerateFieldIndexConverters(subGen, this, maskTypeCol);

            GenerateEqualsCommon(subGen, maskTypeCol);

            await GenerateCreateNewBasicCommon(subGen, maskTypeCol);

            if (GenerateComplexCopySystems)
            {
                GenerateCopy(subGen, maskTypeCol);
            }

            GenerateDeepCopy(subGen, maskTypeCol);

            // Fields might add some content
            foreach (var field in IterateFields())
            {
                field.GenerateInCommon(subGen, maskTypeCol);
            }

            // Modules might add some content
            foreach (var mod in gen.GenerationModules)
            {
                using (new RegionWrapper(subGen, mod.RegionString))
                {
                    await mod.GenerateInCommon(this, subGen, maskTypeCol);
                }
            }

            if (subGen.Empty) return;

            var classGen = commonGen == CommonGenerics.Class;
            var className = $"{CommonClassName(interfaceType, maskTypes)}{(classGen ? GetGenericTypes(maskTypes) : null)}";
            using (var args = new ClassWrapper(sb, className))
            {
                args.Public = PermissionLevel.@internal;
                if (classGen)
                {
                    args.Wheres.AddRange(GenericTypeMaskWheres(interfaceType, maskTypes));
                }
                args.Partial = true;
                if (HasLoquiBaseObject)
                {
                    args.BaseClass = $"{BaseClass.CommonClassName(interfaceType, maskTypes)}{(classGen ? BaseClass.GetGenericTypes(maskTypes) : null)}";
                }
                args.Attributes.AddRange(Attributes.Get(LoquiInterfaceType.Direct));
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"public{NewOverride()}static readonly {className} Instance = new {className}();");
                sb.AppendLine();

                sb.AppendLines(subGen);
            }
            activeMaskCollections.Add(maskTypeCol);
        }

        private async Task GenerateToStringMixIn(StructuredStringBuilder sb)
        {
            using (var args = new FunctionWrapper(sb,
                $"public static string ToString{GetGenericTypes(MaskType.Normal)}"))
            {
                args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.IGetter));
                args.Add($"this {Interface(getter: true, internalInterface: true)} item");
                args.Add($"string? name = null");
                args.Add($"{GetMaskString("bool")}? printMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"return {CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.ToString"))
                {
                    args.Add("item: item");
                    args.Add("name: name");
                    args.Add("printMask: printMask");
                }
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public static void ToString{GetGenericTypes(MaskType.Normal)}"))
            {
                args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.IGetter));
                args.Add($"this {Interface(getter: true, internalInterface: true)} item");
                args.Add($"{nameof(StructuredStringBuilder)} sb");
                args.Add($"string? name = null");
                args.Add($"{GetMaskString("bool")}? printMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.ToString"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("sb");
                    args.AddPassArg("name");
                    args.AddPassArg("printMask");
                }
            }
            sb.AppendLine();
        }

        private void GenerateCommonToString(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.IGetter, CommonGenerics.Class)) return;
            using (var args = new FunctionWrapper(sb,
                $"public string ToString"))
            {
                args.Add($"{Interface(getter: true, internalInterface: true)} item");
                args.Add($"string? name = null");
                args.Add($"{GetMaskString("bool")}? printMask = null");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"var sb = new {nameof(StructuredStringBuilder)}();");
                using (var args = new ArgsWrapper(sb,
                    $"ToString"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("sb");
                    args.AddPassArg("name");
                    args.AddPassArg("printMask");
                }
                sb.AppendLine("return sb.ToString();");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public void ToString"))
            {
                args.Add($"{Interface(getter: true, internalInterface: true)} item");
                args.Add($"{nameof(StructuredStringBuilder)} sb");
                args.Add($"string? name = null");
                args.Add($"{GetMaskString("bool")}? printMask = null");
            }
            using (sb.CurlyBrace())
            {
                string generics = "";
                if (Generics.Any())
                {
                    generics = $"<{string.Join(", ", Generics.Select((g) => g.Key).Select(gen => $"{{typeof({gen}).Name}}"))}>";
                }
                sb.AppendLine("if (name == null)");
                using (sb.CurlyBrace())
                {
                    sb.AppendLine($"sb.AppendLine($\"{Name}{generics} =>\");");
                }
                sb.AppendLine("else");
                using (sb.CurlyBrace())
                {
                    sb.AppendLine($"sb.AppendLine($\"{{name}} ({Name}{generics}) =>\");");
                }
                sb.AppendLine($"sb.AppendLine(\"[\");");
                sb.AppendLine($"using (new DepthWrapper(sb))");
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"ToStringFields"))
                    {
                        args.AddPassArg("item");
                        args.AddPassArg("sb");
                        args.AddPassArg("printMask");
                    }
                }
                sb.AppendLine($"sb.AppendLine(\"]\");");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"protected static void ToStringFields"))
            {
                args.Add($"{Interface(getter: true, internalInterface: true)} item");
                args.Add($"{nameof(StructuredStringBuilder)} sb");
                args.Add($"{GetMaskString("bool")}? printMask = null");
            }
            using (sb.CurlyBrace())
            {
                if (HasLoquiBaseObject)
                {
                    using (var args = new ArgsWrapper(sb,
                        $"{BaseClass.CommonClass(LoquiInterfaceType.IGetter, CommonGenerics.Class)}.ToStringFields"))
                    {
                        args.AddPassArg("item");
                        args.AddPassArg("sb");
                        args.AddPassArg("printMask");
                    }
                }
                foreach (var field in IterateFields())
                {
                    if (!field.IntegrateField) continue;
                    Accessor accessor = Accessor.FromType(field, "item");
                    using (var ifArgs = new IfWrapper(sb, ANDs: true))
                    {
                        ifArgs.Add(gen.MaskModule.GetMaskModule(field.GetType()).GenerateBoolMaskCheck(field, "printMask"), wrapInParens: true);
                        if (field.Nullable && field.CanBeNullable(getter: true))
                        {
                            ifArgs.Add($"item.{field.Name} is {{}} {field.Name}Item");
                            accessor = $"{field.Name}Item";
                        }
                        ifArgs.Body = (subFg) => field.GenerateToString(subFg, field.Name, accessor, "sb");
                    }
                }
            }
            sb.AppendLine();
        }

        private void GenerateFieldIndexConverters(StructuredStringBuilder sb, ObjectGeneration obj, MaskTypeSet maskTypes, bool first = true)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.IGetter, CommonGenerics.Class)) return;
            if (!obj.HasLoquiBaseObject) return;
            var baseObj = obj.BaseClass;
            using (var args = new FunctionWrapper(sb,
                $"public static{NewOverride(doIt: !first)}{FieldIndexName} ConvertFieldIndex"))
            {
                args.Add($"{baseObj.FieldIndexName} index");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine("switch (index)");
                using (sb.CurlyBrace())
                {
                    foreach (var (PublicIndex, InternalIndex, Field) in baseObj.IterateFieldIndices(includeBaseClass: true))
                    {
                        sb.AppendLine($"case {baseObj.FieldIndexName}.{Field.Name}:");
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine($"return ({FieldIndexName})((int)index);");
                        }
                    }

                    sb.AppendLine("default:");
                    using (new DepthWrapper(sb))
                    {
                        GenerateIndexOutOfRangeEx(sb, $"index.{nameof(EnumExt.ToStringFast_Enum_Only)}()");
                    }
                }
            }
            sb.AppendLine();
            GenerateFieldIndexConverters(sb, baseObj, maskTypes, first: false);
        }

        protected virtual async Task GenerateCopyInExtensions(StructuredStringBuilder sb)
        {
            if (IsTopClass)
            {
                using (var args = new FunctionWrapper(sb,
                    $"public static void CopyIn{GetGenericTypes(MaskType.Normal, MaskType.Copy)}"))
                {
                    if (IsTopClass)
                    {
                        args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy));
                    }
                    args.Add($"this {ObjectName} lhs");
                    args.Add($"{(BaseClassTrail().LastOrDefault() ?? this).ObjectName} rhs");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"CopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Assumed(MaskType.Error), GenericTypes_Nickname(MaskType.Copy))}"))
                    {
                        args.AddPassArg($"lhs");
                        args.AddPassArg($"rhs");
                        args.Add("doMasks: false");
                        args.Add($"errorMask: out var errMask");
                        args.Add("copyMask: null");
                    }
                }
                sb.AppendLine();
            }

            using (var args = new FunctionWrapper(sb,
                $"public static void CopyIn{GetGenericTypes(MaskType.Normal, MaskType.Copy)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy));
                args.Add($"this {ObjectName} lhs");
                args.Add($"{ObjectName} rhs");
                args.Add($"{Mask(MaskType.Copy)} copyMask");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"CopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Assumed(MaskType.Error), GenericTypes_Nickname(MaskType.Copy))}"))
                {
                    args.AddPassArg($"lhs");
                    args.AddPassArg($"rhs");
                    args.Add("doMasks: false");
                    args.Add("errorMask: out var errMask");
                    args.AddPassArg("copyMask");
                }
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public static void CopyIn{GetGenericTypes(MaskType.Normal, MaskType.Error, MaskType.Copy)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Error, MaskType.Copy));
                args.Add($"this {ObjectName} lhs");
                args.Add($"{ObjectName} rhs");
                args.Add($"out {Mask(MaskType.Error)} errorMask");
                args.Add($"{Mask(MaskType.Copy)} copyMask = null");
                args.Add($"bool doMasks = true");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"var errorMaskBuilder = doMasks ? new ErrorMaskBuilder() : null;");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("lhs", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Copy)}.CopyIn"))
                {
                    args.Add("item: lhs");
                    args.AddPassArg($"rhs");
                    args.Add("errorMask: errorMaskBuilder");
                    args.AddPassArg($"copyMask");
                }
                sb.AppendLine($"errorMask = {Mask(MaskType.Error)}.Factory(errorMaskBuilder);");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public static void CopyIn{GetGenericTypes(MaskType.Normal, MaskType.Copy)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy));
                args.Add($"this {ObjectName} lhs");
                args.Add($"{ObjectName} rhs");
                args.Add($"ErrorMaskBuilder errorMask");
                args.Add($"{Mask(MaskType.Copy)} copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("lhs", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Copy)}.CopyIn"))
                {
                    args.Add("item: lhs");
                    args.AddPassArg($"rhs");
                    args.AddPassArg($"errorMask");
                    args.AddPassArg($"copyMask");
                }
            }
            sb.AppendLine();
        }

        protected virtual async Task GenerateDeepCopyInExtensions(StructuredStringBuilder sb)
        {
            if (IsTopClass)
            {
                using (var args = new FunctionWrapper(sb,
                    $"public static void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                {
                    if (IsTopClass)
                    {
                        args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                    }
                    args.Add($"this {Interface(getter: false, internalInterface: true)} lhs");
                    args.Add($"{(BaseClassTrail().LastOrDefault() ?? this).Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} rhs");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"{CommonClassInstance("lhs", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                    {
                        args.Add("item: lhs");
                        args.AddPassArg($"rhs");
                        args.Add("errorMask: default");
                        args.Add($"copyMask: default");
                        args.Add($"deepCopy: false");
                    }
                }
                sb.AppendLine();

                using (var args = new FunctionWrapper(sb,
                    $"public static void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Translation)}"))
                {
                    if (IsTopClass)
                    {
                        args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter, MaskType.Translation));
                    }
                    args.Add($"this {Interface(getter: false, internalInterface: true)} lhs");
                    args.Add($"{(BaseClassTrail().LastOrDefault() ?? this).Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} rhs");
                    args.Add($"{Mask(MaskType.Translation)}? copyMask = null");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"{CommonClassInstance("lhs", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                    {
                        args.Add("item: lhs");
                        args.AddPassArg($"rhs");
                        args.Add("errorMask: default");
                        args.Add($"copyMask: copyMask?.GetCrystal()");
                        args.Add($"deepCopy: false");
                    }
                }
                sb.AppendLine();
            }

            using (var args = new FunctionWrapper(sb,
                $"public static void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation));
                args.Add($"this {Interface(getter: false, internalInterface: true)} lhs");
                args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} rhs");
                args.Add($"out {Mask(MaskType.Error)} errorMask");
                args.Add($"{Mask(MaskType.Translation)}? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"var errorMaskBuilder = new ErrorMaskBuilder();");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("lhs", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                {
                    args.Add("item: lhs");
                    args.AddPassArg($"rhs");
                    args.Add("errorMask: errorMaskBuilder");
                    args.Add($"copyMask: copyMask?.GetCrystal()");
                    args.Add($"deepCopy: false");
                }
                sb.AppendLine($"errorMask = {Mask(MaskType.Error)}.Factory(errorMaskBuilder);");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public static void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                args.Add($"this {Interface(getter: false, internalInterface: true)} lhs");
                args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} rhs");
                args.Add($"ErrorMaskBuilder? errorMask");
                args.Add($"TranslationCrystal? copyMask");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("lhs", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                {
                    args.Add("item: lhs");
                    args.AddPassArg($"rhs");
                    args.AddPassArg($"errorMask");
                    args.AddPassArg($"copyMask");
                    args.Add($"deepCopy: false");
                }
            }
            sb.AppendLine();
        }

        protected virtual async Task GenerateDeepCopyIn(StructuredStringBuilder sb)
        {
            if (IsTopClass)
            {
                using (var args = new FunctionWrapper(sb,
                    $"public void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.Translation)}"))
                {
                    if (IsTopClass)
                    {
                        args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation));
                    }
                    args.Add($"this {Interface(getter: false)} lhs");
                    args.Add($"{(BaseClassTrail().LastOrDefault() ?? this).Interface(getter: true)} rhs");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Assumed(MaskType.Error), GenericTypes_Nickname(MaskType.Translation))}"))
                    {
                        args.AddPassArg($"lhs");
                        args.AddPassArg($"rhs");
                        args.Add("doMasks: false");
                        args.Add($"errorMask: out var errMask");
                        args.Add("copyMask: null");
                    }
                }
                sb.AppendLine();
            }

            using (var args = new FunctionWrapper(sb,
                $"public void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation));
                args.Add($"this {Interface(getter: false)} lhs");
                args.Add($"{Interface(getter: true)} rhs");
                args.Add($"{Mask(MaskType.Translation)} copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Assumed(MaskType.Error), GenericTypes_Nickname(MaskType.Translation))}"))
                {
                    args.AddPassArg($"lhs");
                    args.AddPassArg($"rhs");
                    args.Add("doMasks: false");
                    args.Add("errorMask: out var errMask");
                    args.AddPassArg("copyMask");
                }
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.Error, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Error, MaskType.Translation));
                args.Add($"this {Interface(false)} lhs");
                args.Add($"{Interface(true)} rhs");
                args.Add($"out {Mask(MaskType.Error)} errorMask");
                args.Add($"{Mask(MaskType.Translation)} copyMask = null");
                args.Add($"bool doMasks = true");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"var errorMaskBuilder = new ErrorMaskBuilder();");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClass(LoquiInterfaceType.IGetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation)}.DeepCopyIn"))
                {
                    args.Add("item: lhs");
                    args.AddPassArg($"rhs");
                    args.Add("errorMask: errorMaskBuilder");
                    args.AddPassArg($"copyMask");
                }
                sb.AppendLine($"errorMask = {Mask(MaskType.Error)}.Factory(errorMaskBuilder);");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation));
                args.Add($"this {Interface(getter: false)} lhs");
                args.Add($"{Interface(getter: true)} rhs");
                args.Add($"ErrorMaskBuilder errorMask");
                args.Add($"{Mask(MaskType.Translation)} copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClass(LoquiInterfaceType.IGetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation)}.DeepCopyIn"))
                {
                    args.Add("item: lhs");
                    args.AddPassArg($"rhs");
                    args.AddPassArg($"errorMask");
                    args.AddPassArg($"copyMask");
                }
            }
            sb.AppendLine();
        }

        protected virtual void GenerateCopyInCommon(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Copy)) return;
            throw new NotImplementedException();
            //using (new RegionWrapper(sb, "Copy Fields From"))
            //{
            //    using (var args = new FunctionWrapper(sb,
            //        $"public void CopyIn{this.GetGenericTypes(MaskType.Normal, MaskType.Copy)}"))
            //    {
            //        args.Wheres.AddRange(this.GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy));
            //        args.Add($"{this.ObjectName} item");
            //        args.Add($"{this.ObjectName} rhs");
            //        args.Add($"ErrorMaskBuilder errorMask");
            //        args.Add($"{this.Mask(MaskType.Copy)} copyMask");
            //    }
            //    using (new BraceWrapper(sb))
            //    {
            //        GenerateCopyForFields(
            //            sb,
            //            "item",
            //            "rhs",
            //            errMaskAccessor: "errorMask",
            //            copyMaskAccessor: "copyMask",
            //            deepCopy: false);
            //    }
            //    sb.AppendLine();
            //}
        }

        protected virtual void GenerateDeepCopyInCommon(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation)) return;

            using (new RegionWrapper(sb, "DeepCopyIn"))
            {
                if (HasInternalGetInterface || HasInternalSetInterface)
                {
                    using (var args = new FunctionWrapper(sb,
                        $"public{Virtual()}void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                    {
                        if (IsTopClass)
                        {
                            args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                        }
                        args.Add($"{Interface(getter: false, internalInterface: true)} item");
                        args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} rhs");
                        args.Add($"ErrorMaskBuilder? errorMask");
                        args.Add($"TranslationCrystal? copyMask");
                        args.Add($"bool deepCopy");
                    }
                    using (sb.CurlyBrace())
                    {
                        GenerateCopyForFields(
                            sb,
                            "item",
                            "rhs",
                            errMaskAccessor: "errorMask",
                            copyMaskAccessor: "copyMask",
                            deepCopy: true,
                            internalCopy: true);
                        if (!BaseClassTrail().Any(b => b.HasInternalGetInterface || b.HasInternalSetInterface))
                        {
                            using (var args = new ArgsWrapper(sb,
                                $"DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                            {
                                args.Add($"({Interface(getter: false)})item");
                                args.Add($"({Interface(GetGenericTypes(MaskType.NormalGetter), getter: true)})rhs");
                                args.AddPassArg("errorMask");
                                args.AddPassArg("copyMask");
                                args.AddPassArg("deepCopy");
                            }
                        }
                    }
                    sb.AppendLine();
                }

                using (var args = new FunctionWrapper(sb,
                    $"public{Virtual()}void DeepCopyIn{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                {
                    args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                    args.Add($"{Interface(getter: false)} item");
                    args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true)} rhs");
                    args.Add($"ErrorMaskBuilder? errorMask");
                    args.Add($"TranslationCrystal? copyMask");
                    args.Add($"bool deepCopy");
                }
                using (sb.CurlyBrace())
                {
                    GenerateCopyForFields(
                        sb,
                        "item",
                        "rhs",
                        errMaskAccessor: "errorMask",
                        copyMaskAccessor: "copyMask",
                        deepCopy: true,
                        internalCopy: false);
                }
                sb.AppendLine();

                foreach (var baseClass in BaseClassTrail())
                {
                    if (baseClass.HasInternalGetInterface || baseClass.HasInternalSetInterface)
                    {
                        using (var args = new FunctionWrapper(sb,
                            $"public override void DeepCopyIn{baseClass.GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                        {
                            if (IsTopClass)
                            {
                                args.Wheres.AddRange(baseClass.GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                            }
                            args.Add($"{baseClass.Interface(getter: false, internalInterface: true)} item");
                            args.Add($"{baseClass.Interface(baseClass.GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} rhs");
                            args.Add($"ErrorMaskBuilder? errorMask");
                            args.Add($"TranslationCrystal? copyMask");
                            args.Add($"bool deepCopy");
                        }
                        using (sb.CurlyBrace())
                        {
                            using (var args = new ArgsWrapper(sb,
                                $"this.DeepCopyIn"))
                            {
                                args.Add($"item: ({Interface(getter: false, internalInterface: true)})item");
                                args.Add($"rhs: ({Interface(baseClass.GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)})rhs");
                                args.AddPassArg("errorMask");
                                args.AddPassArg("copyMask");
                                args.AddPassArg("deepCopy");
                            }
                        }
                    }
                    sb.AppendLine();

                    using (var args = new FunctionWrapper(sb,
                        $"public override void DeepCopyIn{baseClass.GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                    {
                        if (IsTopClass)
                        {
                            args.Wheres.AddRange(baseClass.GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                        }
                        args.Add($"{baseClass.Interface(getter: false)} item");
                        args.Add($"{baseClass.Interface(baseClass.GetGenericTypes(MaskType.NormalGetter), getter: true)} rhs");
                        args.Add($"ErrorMaskBuilder? errorMask");
                        args.Add($"TranslationCrystal? copyMask");
                        args.Add($"bool deepCopy");
                    }
                    using (sb.CurlyBrace())
                    {
                        using (var args = new ArgsWrapper(sb,
                            $"this.DeepCopyIn"))
                        {
                            args.Add($"item: ({Interface(getter: false)})item");
                            args.Add($"rhs: ({Interface(baseClass.GetGenericTypes(MaskType.NormalGetter), getter: true)})rhs");
                            args.AddPassArg("errorMask");
                            args.AddPassArg("copyMask");
                            args.AddPassArg("deepCopy");
                        }
                    }
                    sb.AppendLine();
                }
            }
        }

        private void GenerateCopyForFields(
            StructuredStringBuilder sb,
            string accessorPrefix,
            string rhsAccessorPrefix,
            string errMaskAccessor,
            string copyMaskAccessor,
            bool deepCopy,
            bool internalCopy)
        {
            if (HasLoquiBaseObject)
            {
                var funcStr = deepCopy
                    ? $"base.DeepCopyIn{GetBaseGenericTypes(MaskType.Normal)}"
                    : $"base.CopyIn{GetBaseGenericTypes(MaskType.Normal, MaskType.Copy)}";
                using (var args = new ArgsWrapper(sb, funcStr))
                {
                    args.Add($"{(internalCopy ? null : $"({BaseClass.Interface(getter: false, internalInterface: false)})")}{accessorPrefix}");
                    args.Add($"{(internalCopy ? null : $"({BaseClass.Interface(getter: true, internalInterface: false)})")}{rhsAccessorPrefix}");
                    args.Add(errMaskAccessor);
                    args.Add(copyMaskAccessor);
                    args.AddPassArg("deepCopy");
                }
            }

            foreach (var item in IterateFieldIndices(nonIntegrated: true))
            {
                if (item.Field.CopyLevel == CopyLevel.None) continue;
                var internalField = item.Field.InternalGetInterface || item.Field.InternalSetInterface;
                if (internalField != internalCopy) continue;
                if (!item.Field.Enabled) continue;

                if (item.Field.CopyLevel == CopyLevel.DeepCopyOnly)
                {
                    sb.AppendLine("if (deepCopy)");
                }
                using (sb.CurlyBrace(doIt: item.Field.CopyLevel == CopyLevel.DeepCopyOnly))
                {
                    item.Field.GenerateForCopy(
                        sb,
                        Accessor.FromType(item.Field, accessorPrefix),
                        Accessor.FromType(item.Field, rhsAccessorPrefix),
                        deepCopy ? copyMaskAccessor : Accessor.FromType(item.Field, copyMaskAccessor, nullable: TypeExt.IsNullable(item.Field.GetType())),
                        protectedMembers: false,
                        deepCopy: deepCopy);
                }
            }
        }

        #region Generation Snippets
        public async Task GenerateRouting(StructuredStringBuilder sb, bool getterOnly)
        {
            MaskTypeSetCollection maskSets = await MaskTypeSetCollection;
            using (new RegionWrapper(sb, "Common Routing"))
            {
                // ToDo
                // Eventually detect and generate all applicable combinations

                var typeInParams = $"{string.Join(", ", Generics.Select((_, i) => $"Type type{i}"))}";
                var typeOutParams = $"{string.Join(", ", Generics.Select((_, i) => $"type{i}"))}";

                string AddGenericWrap(string instance)
                {
                    if (!IsGeneric) return instance;
                    if (Generics.Count != 1)
                    {
                        throw new NotImplementedException();
                    }
                    return $"{nameof(GenericCommonInstanceGetter)}.{nameof(GenericCommonInstanceGetter.Get)}({instance}, typeof({Generics.First().Key}), type0)";
                }

                sb.AppendLine($"[DebuggerBrowsable(DebuggerBrowsableState.Never)]");
                sb.AppendLine($"ILoquiRegistration ILoquiObject.Registration => {RegistrationName}.Instance;");
                sb.AppendLine($"public{NewOverride()}static {nameof(ILoquiRegistration)} StaticRegistration => {RegistrationName}.Instance;");
                sb.AppendLine("[DebuggerStepThrough]");
                sb.AppendLine($"protected{FunctionOverride()}object Common{CommonNameAdditions(LoquiInterfaceType.IGetter, MaskType.Normal)}Instance({typeInParams}) => {AddGenericWrap($"{CommonClassRouter(maskSets, LoquiInterfaceType.IGetter, CommonGenerics.Class, MaskType.Normal)}.Instance")};");
                if (!getterOnly)
                {
                    sb.AppendLine("[DebuggerStepThrough]");
                    using (var args = new FunctionWrapper(sb,
                        $"protected{FunctionOverride()}object Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal)}Instance"))
                    {
                        if (!string.IsNullOrWhiteSpace(typeInParams))
                        {
                            args.Add(typeInParams);
                        }
                    }
                    using (sb.CurlyBrace())
                    {
                        sb.AppendLine($"return {AddGenericWrap($"{CommonClassRouter(maskSets, LoquiInterfaceType.ISetter, CommonGenerics.Class, MaskType.Normal)}.Instance")};");
                    }
                    if (GenerateComplexCopySystems)
                    {
                        sb.AppendLine("[DebuggerStepThrough]");
                        using (var args = new FunctionWrapper(sb,
                            $"protected{FunctionOverride()}object Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{GetGenericTypes(MaskType.Copy)}"))
                        {
                            if (IsTopClass)
                            {
                                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, maskTypes: MaskType.Copy));
                            }
                            if (!string.IsNullOrWhiteSpace(typeInParams))
                            {
                                args.Add(typeInParams);
                            }
                        }
                        using (sb.CurlyBrace())
                        {
                            sb.AppendLine($"return {CommonClassRouter(maskSets, LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Copy)}.Instance;");
                        }
                    }
                }
                sb.AppendLine("[DebuggerStepThrough]");
                sb.AppendLine($"protected{FunctionOverride()}object Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation)}Instance() => {CommonClassRouter(maskSets, LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation)}.Instance;");
                if (IsTopClass)
                {
                    sb.AppendLine("[DebuggerStepThrough]");
                    sb.AppendLine($"object {Interface(getter: true, internalInterface: false)}.Common{CommonNameAdditions(LoquiInterfaceType.IGetter)}Instance({typeInParams}) => this.Common{CommonNameAdditions(LoquiInterfaceType.IGetter)}Instance({typeOutParams});");
                    if (getterOnly)
                    {
                        sb.AppendLine("[DebuggerStepThrough]");
                        sb.AppendLine($"object? {Interface(getter: true, internalInterface: false)}.Common{CommonNameAdditions(LoquiInterfaceType.ISetter)}Instance({typeInParams}) => null;");
                        if (GenerateComplexCopySystems)
                        {
                            sb.AppendLine("[DebuggerStepThrough]");
                            sb.AppendLine($"object {Interface(getter: true, internalInterface: false)}.Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{GetGenericTypes(MaskType.Copy)}({typeInParams}) => null;");
                        }
                    }
                    else
                    {
                        sb.AppendLine("[DebuggerStepThrough]");
                        sb.AppendLine($"object {Interface(getter: true, internalInterface: false)}.Common{CommonNameAdditions(LoquiInterfaceType.ISetter)}Instance({typeInParams}) => this.Common{CommonNameAdditions(LoquiInterfaceType.ISetter)}Instance({typeOutParams});");
                        if (GenerateComplexCopySystems)
                        {
                            sb.AppendLine("[DebuggerStepThrough]");
                            sb.AppendLine($"object {Interface(getter: true, internalInterface: false)}.Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{GetGenericTypes(MaskType.Copy)}({typeInParams}) => this.Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{GetGenericTypes(MaskType.Copy)}({typeOutParams});");
                        }
                    }
                    sb.AppendLine("[DebuggerStepThrough]");
                    sb.AppendLine($"object {Interface(getter: true, internalInterface: false)}.Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation)}Instance() => this.Common{CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation)}Instance();");
                }
                sb.AppendLine();

                foreach (var associatedObj in Interfaces
                    .Select(i => i.AssociatedObject)
                    .NotNull()
                    .Distinct())
                {
                    sb.AppendLine("[DebuggerStepThrough]");
                    sb.AppendLine($"object {associatedObj.Interface(getter: true, internalInterface: false)}.Common{associatedObj.CommonNameAdditions(LoquiInterfaceType.IGetter)}Instance() => {associatedObj.CommonClassRouter(maskSets, LoquiInterfaceType.IGetter, CommonGenerics.Class, MaskType.Normal)}.Instance;");
                    if (getterOnly)
                    {
                        sb.AppendLine("[DebuggerStepThrough]");
                        sb.AppendLine($"object? {associatedObj.Interface(getter: true, internalInterface: false)}.Common{associatedObj.CommonNameAdditions(LoquiInterfaceType.ISetter)}Instance() => null;");
                        if (associatedObj.GenerateComplexCopySystems)
                        {
                            sb.AppendLine("[DebuggerStepThrough]");
                            sb.AppendLine($"object {associatedObj.Interface(getter: true, internalInterface: false)}.Common{associatedObj.CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{associatedObj.GetGenericTypes(MaskType.Copy)}() => null;");
                        }
                    }
                    else
                    {
                        sb.AppendLine("[DebuggerStepThrough]");
                        sb.AppendLine($"object {associatedObj.Interface(getter: true, internalInterface: false)}.Common{associatedObj.CommonNameAdditions(LoquiInterfaceType.ISetter)}Instance() => {associatedObj.CommonClassRouter(maskSets, LoquiInterfaceType.ISetter, CommonGenerics.Class, MaskType.Normal)}.Instance;");
                        if (associatedObj.GenerateComplexCopySystems)
                        {
                            sb.AppendLine("[DebuggerStepThrough]");
                            sb.AppendLine($"object {associatedObj.Interface(getter: true, internalInterface: false)}.Common{associatedObj.CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy)}Instance{associatedObj.GetGenericTypes(MaskType.Copy)}() => {associatedObj.CommonClassRouter(maskSets, LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Copy)}.Instance;");
                        }
                    }
                    sb.AppendLine("[DebuggerStepThrough]");
                    sb.AppendLine($"object {associatedObj.Interface(getter: true, internalInterface: false)}.Common{associatedObj.CommonNameAdditions(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Translation)}Instance() => {associatedObj.CommonClassRouter(maskSets, LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation)}.Instance;");
                    sb.AppendLine();
                }
            }
        }

        public string CommonClassRouter(MaskTypeSetCollection maskSets, LoquiInterfaceType interfaceType, CommonGenerics commonGen, params MaskType[] maskTypes)
        {
            // ToDo Eventually route into one common class if only that needed
            //if (maskSets.Contains(interfaceType, maskTypes))
            {
                return CommonClass(interfaceType, commonGen, maskTypes);
            }
            //else
            //{ // Fallback
            //    return this.CommonClass(LoquiInterfaceType.IGetter, MaskType.Normal);
            //}
        }

        protected abstract Task GenerateCtor(StructuredStringBuilder sb);

        protected async Task GenerateStaticCtor(StructuredStringBuilder sb)
        {
            StructuredStringBuilder staticCtorSB = new StructuredStringBuilder();
            foreach (var mod in gen.GenerationModules)
            {
                await mod.GenerateInStaticCtor(this, staticCtorSB);
            }
            foreach (var field in IterateFields())
            {
                field.GenerateForStaticCtor(staticCtorSB);
            }
            if (staticCtorSB.Empty) return;
            sb.AppendLine($"static {Name}()");
            using (sb.CurlyBrace())
            {
                sb.AppendLines(staticCtorSB);
            }
            sb.AppendLine();
        }

        protected abstract Task GenerateClassLine(StructuredStringBuilder sb);

        public async Task GenerateLoquiReflectionGetterInterface(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Loqui Getter Interface"))
            {
                sb.AppendLine();

                sb.AppendLine($"protected{FunctionOverride()}object GetNthObject(ushort index) => {CommonClassName(LoquiInterfaceType.IGetter)}.GetNthObject{GetGenericTypes(MaskType.Normal)}(index, this);");
                if (IsTopClass)
                {
                    sb.AppendLine($"object {nameof(ILoquiReflectionGetter)}.GetNthObject(ushort index) => this.GetNthObject(index);");
                }
                sb.AppendLine();

                sb.AppendLine($"protected{FunctionOverride()}void UnsetNthObject(ushort index) => {CommonClassName(LoquiInterfaceType.ISetter)}.UnsetNthObject{GetGenericTypes(MaskType.Normal)}(index, this);");
                if (IsTopClass)
                {
                    sb.AppendLine($"void {nameof(ILoquiReflectionSetter)}.UnsetNthObject(ushort index) => this.UnsetNthObject(index);");
                }
                sb.AppendLine();
            }
        }

        protected virtual async Task GenerateLoquiReflectionSetterInterface(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "Loqui Interface"))
            {
            }
        }

        private void GenerateGetNthObject(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.IGetter, CommonGenerics.Class)) return;
            using (var args = new FunctionWrapper(sb,
                $"public static object GetNthObject"))
            {
                args.Add($"ushort index");
                args.Add($"{Interface(getter: true)} obj");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (field.IntegrateField)
                        {
                            sb.AppendLine($"case {field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField))
                        {
                            field.GenerateGetNth(sb, Accessor.FromType(field, "obj"));
                        }
                    }

                    GenerateStandardIndexDefault(sb, LoquiInterfaceType.IGetter, "GetNthObject", "index", true, true, "obj");
                }
            }
            sb.AppendLine();
        }

        protected virtual async Task GenerateSetNthObject(StructuredStringBuilder sb)
        {
            if (IsTopClass && GenerateNthReflections)
            {
                sb.AppendLine($"void {nameof(ILoquiReflectionSetter)}.SetNthObject(ushort index, object obj) => this.SetNthObject(index, obj);");
            }
            sb.AppendLine($"protected{FunctionOverride()}void SetNthObject(ushort index, object obj)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    var derivatives = IterateFieldIndices()
                        .Where((f) => f.Field.Derivative).ToList();
                    if (derivatives.Count > 0)
                    {
                        foreach (var item in derivatives)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("throw new ArgumentException($\"Tried to set at a derivative index {index}\");");
                        }
                    }
                    foreach (var field in IterateFields())
                    {
                        if (field.Derivative) continue;
                        if (field.IntegrateField)
                        {
                            sb.AppendLine($"case {field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField))
                        {
                            field.GenerateSetNth(
                                sb,
                                accessor: $"this.{field.Name}",
                                rhs: $"({field.TypeName(getter: false)})obj",
                                internalUse: false);
                        }
                    }

                    GenerateStandardIndexDefault(sb, LoquiInterfaceType.IGetter, "SetNthObject", "index", false, false, "obj");
                }
            }
            sb.AppendLine();
        }

        protected virtual void GenerateUnsetNthObject(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.ISetter, CommonGenerics.Class)) return;
            using (var args = new FunctionWrapper(sb,
                $"public static void UnsetNthObject"))
            {
                args.Add("ushort index");
                args.Add($"{Interface()} obj");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    var derivatives = IterateFieldIndices()
                        .Where((f) => f.Field.Derivative).ToList();
                    if (derivatives.Count > 0)
                    {
                        foreach (var item in derivatives)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("throw new ArgumentException($\"Tried to unset at a derivative index {index}\");");
                        }
                    }
                    foreach (var field in IterateFields())
                    {
                        if (field.Derivative) continue;

                        if (field.IntegrateField)
                        {
                            sb.AppendLine($"case {field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField))
                        {
                            if (field.IntegrateField && field.ReadOnly)
                            {
                                sb.AppendLine("throw new ArgumentException(\"Tried to set at a readonly index \" + index);");
                            }
                            else
                            {
                                field.GenerateUnsetNth(sb, Accessor.FromType(field, "obj"));
                            }
                        }
                    }

                    GenerateStandardIndexDefault(sb, LoquiInterfaceType.ISetter, "UnsetNthObject", "index", false, true, "obj");
                }
            }
            sb.AppendLine();
        }

        private void GenerateNthObjectIsLoqui(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static bool GetNthIsLoqui(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    Func<TypeGeneration, bool> tester = (t) =>
                    {
                        if (t is LoquiType)
                        {
                            return true;
                        }
                        else if (t is WrapperType wrapper)
                        {
                            if (wrapper.SubTypeGeneration is LoquiType)
                            {
                                return true;
                            }
                            else
                            {
                                return false;
                            }
                        }
                        else
                        {
                            return false;
                        }
                    };

                    var trues = IterateFieldIndices().Where((i) => tester(i.Field));
                    var falses = IterateFieldIndices().Where((i) => !tester(i.Field));
                    if (trues.Any())
                    {
                        foreach (var item in trues)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return true;");
                        }
                    }
                    if (falses.Any())
                    {
                        foreach (var item in falses)
                        {
                            if (!item.Field.IntegrateField || !item.Field.Enabled) continue;
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return false;");
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "GetNthIsLoqui", "index", true);
                }
            }
            sb.AppendLine();
        }

        private void GenerateNthObjectIsDerivative(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static bool IsNthDerivative(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    var trues = IterateFieldIndices().Where((i) => i.Field.Derivative);
                    var falses = IterateFieldIndices().Where((i) => !i.Field.Derivative);
                    if (trues.Any())
                    {
                        foreach (var item in trues)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return true;");
                        }
                    }
                    if (falses.Any())
                    {
                        foreach (var item in falses)
                        {
                            if (!item.Field.IntegrateField || !item.Field.Enabled) continue;
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return false;");
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "IsNthDerivative", "index", true);
                }
            }
            sb.AppendLine();
        }

        private void GenerateNthObjectIsEnumerable(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static bool GetNthIsEnumerable(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    var trues = IterateFieldIndices().Where((i) => i.Field is ContainerType);
                    var falses = IterateFieldIndices().Where((i) => !(i.Field is ContainerType));
                    if (trues.Any())
                    {
                        foreach (var item in trues)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return true;");
                        }
                    }
                    if (falses.Any())
                    {
                        foreach (var item in falses)
                        {
                            if (!item.Field.IntegrateField || !item.Field.Enabled) continue;
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return false;");
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "GetNthIsEnumerable", "index", true);
                }
            }
            sb.AppendLine();
        }

        private void GenerateGetNthType(StructuredStringBuilder sb, bool generic)
        {
            sb.AppendLine($"public{(generic ? " new " : " ")}static Type GetNthType(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (field.IntegrateField && field.Enabled)
                        {
                            sb.AppendLine($"case {field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField))
                        {
                            field.GenerateGetNthType(sb);
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "GetNthType", "index", true);
                }
            }
            sb.AppendLine();
        }

        private void GenerateGetNthName(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static string GetNthName(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (field.IntegrateField && field.Enabled)
                        {
                            sb.AppendLine($"case {field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField && field.Enabled))
                        {
                            field.GenerateGetNthName(sb);
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "GetNthName", "index", true);
                }
            }
            sb.AppendLine();
        }

        private void GenerateGetNthIsSingleton(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static bool GetNthIsSingleton(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    Func<TypeGeneration, bool> tester = (f) =>
                    {
                        if (!(f is LoquiType loqui)) return false;
                        return loqui.Singleton;
                    };
                    var trues = IterateFieldIndices().Where((i) => tester(i.Field));
                    var falses = IterateFieldIndices().Where((i) => !tester(i.Field));
                    if (trues.Any())
                    {
                        foreach (var item in trues)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return true;");
                        }
                    }
                    if (falses.Any())
                    {
                        foreach (var item in falses)
                        {
                            if (!item.Field.IntegrateField || !item.Field.Enabled) continue;
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return false;");
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "GetNthIsSingleton", "index", true);
                }
            }
            sb.AppendLine();
        }

        public void GenerateGetterInterfaceImplementations(StructuredStringBuilder sb)
        {
            sb.AppendLine($"void {nameof(IPrintable)}.ToString({nameof(StructuredStringBuilder)} sb, string? name) => this.ToString(sb, name);");
            //sb.AppendLine($"IMask<bool> IEqualsMask.GetEqualsMask(object rhs, EqualsMaskHelper.Include include) => this.GetEqualsMask(({this.Interface(getter: true, internalInterface: true)})rhs, include);");
            sb.AppendLine();
        }

        protected virtual async Task GenerateGetEqualsMaskMixIn(StructuredStringBuilder sb)
        {
            using (var args = new FunctionWrapper(sb, $"public static {GetMaskString("bool")} GetEqualsMask{GetGenericTypes(MaskType.Normal)}"))
            {
                args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.IGetter));
                args.Add($"this {Interface(getter: true, internalInterface: true)} item");
                args.Add($"{Interface(getter: true, internalInterface: true)} rhs");
                args.Add($"EqualsMaskHelper.Include include = EqualsMaskHelper.Include.All");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"return {CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.GetEqualsMask"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("rhs");
                    args.AddPassArg("include");
                }
            }
            sb.AppendLine();
        }

        private void GenerateGetEqualsMask(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.IGetter, CommonGenerics.Class)) return;
            using (var args = new FunctionWrapper(sb, $"public {GetMaskString("bool")} GetEqualsMask"))
            {
                args.Add($"{Interface(getter: true, internalInterface: true)} item");
                args.Add($"{Interface(getter: true, internalInterface: true)} rhs");
                args.Add($"EqualsMaskHelper.Include include = EqualsMaskHelper.Include.All");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"var ret = new {GetMaskString("bool")}(false);");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.FillEqualsMask"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("rhs");
                    args.AddPassArg("ret");
                    args.AddPassArg("include");
                }
                sb.AppendLine("return ret;");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb, $"public void FillEqualsMask"))
            {
                args.Add($"{Interface(getter: true, internalInterface: true)} item");
                args.Add($"{Interface(getter: true, internalInterface: true)} rhs");
                args.Add($"{GetMaskString("bool")} ret");
                args.Add($"EqualsMaskHelper.Include include = EqualsMaskHelper.Include.All");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine("if (rhs == null) return;");
                foreach (var field in IterateFields())
                {
                    if (!HasKeyField() || field.KeyField)
                    {
                        field.GenerateForEqualsMask(
                            sb,
                            Accessor.FromType(field, $"item"),
                            Accessor.FromType(field, "rhs"),
                            $"ret.{field.Name}");
                    }
                }
                if (HasLoquiBaseObject)
                {
                    sb.AppendLine($"base.FillEqualsMask(item, rhs, ret, include);");
                }
            }
            sb.AppendLine();
        }

        public void GenerateStandardRegistrationDefault(StructuredStringBuilder sb, string functionName, string indexAccessor, bool ret, params string[] otherParameters)
        {
            sb.AppendLine("default:");
            using (new DepthWrapper(sb))
            {
                if (HasLoquiBaseObject)
                {
                    sb.AppendLine($"{(ret ? "return " : string.Empty)}{BaseClass.RegistrationName}.{functionName}({string.Join(", ", indexAccessor.AsEnumerable().And(otherParameters))});");
                    if (!ret)
                    {
                        sb.AppendLine("break;");
                    }
                }
                else
                {
                    GenerateIndexOutOfRangeEx(sb, indexAccessor);
                }
            }
        }

        public void GenerateStandardIndexDefault(
            StructuredStringBuilder sb,
            LoquiInterfaceType loquiInterface,
            string functionName,
            string indexAccessor,
            bool ret,
            bool common,
            params string[] otherParameters)
        {
            sb.AppendLine("default:");
            using (new DepthWrapper(sb))
            {
                if (HasLoquiBaseObject)
                {
                    if (common)
                    {
                        sb.AppendLine($"{(ret ? "return " : string.Empty)}{BaseClass.CommonClassName(loquiInterface)}.{functionName}{BaseGenericTypes}({string.Join(", ", indexAccessor.AsEnumerable().And(otherParameters))});");
                    }
                    else
                    {
                        sb.AppendLine($"{(ret ? "return " : string.Empty)}base.{functionName}({string.Join(", ", indexAccessor.AsEnumerable().And(otherParameters))});");
                    }
                    if (!ret)
                    {
                        sb.AppendLine("break;");
                    }
                }
                else
                {
                    GenerateIndexOutOfRangeEx(sb, indexAccessor);
                }
            }
        }

        public void GenerateIndexOutOfRangeEx(StructuredStringBuilder sb, string indexAccessor)
        {
            sb.AppendLine($"throw new ArgumentException($\"Index is out of range: {{{indexAccessor}}}\");");
        }

        private void GenerateGetNameIndex(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static ushort? GetNameIndex(StringCaseAgnostic str)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine("switch (str.Upper)");
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (field.IntegrateField)
                        {
                            if (string.IsNullOrWhiteSpace(field.Name)) return;
                            sb.AppendLine($"case \"{field.Name.ToUpper()}\":");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField))
                        {
                            field.GenerateGetNameIndex(sb);
                        }
                    }

                    sb.AppendLine("default:");
                    using (new DepthWrapper(sb))
                    {
                        sb.AppendLine("return null;");
                    }
                }
            }
            sb.AppendLine();
        }

        private async Task AddNamespaces(StructuredStringBuilder sb)
        {
            RequiredNamespaces.Add(
                await gen.GenerationModules.ToAsyncEnumerable()
                    .SelectMany((tr) => tr.RequiredUsingStatements(this))
                    .ToListAsync());
            RequiredNamespaces.Add(
                (await Task.WhenAll(GenerationInterfaces.Select((tr) => tr.RequiredUsingStatements())))
                    .SelectMany(i => i));
            using (new RegionWrapper(sb, "Usings"))
            {
                foreach (var nameSpace in RequiredNamespaces.Union(gen.Namespaces).OrderBy(x => x))
                {
                    sb.AppendLine($"using {nameSpace};");
                }
            }
        }

        public void GenerateEqualsSection(StructuredStringBuilder sb)
        {
            // Generate equals and hash
            if (GenerateEquals)
            {
                using (new RegionWrapper(sb, "Equals and Hash")) 
                {
                    sb.AppendLine("public override bool Equals(object? obj)");
                    using (sb.CurlyBrace())
                    {
                        sb.AppendLine($"if (obj is not {Interface(getter: true, internalInterface: true)} rhs) return false;");
                        sb.AppendLine($"return {CommonClassInstance("this", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.Equals(this, rhs, crystal: null);");
                    }
                    sb.AppendLine();

                    sb.AppendLine($"public bool Equals({Interface(getter: true, internalInterface: true)}? obj)");
                    using (sb.CurlyBrace())
                    {
                        sb.AppendLine($"return {CommonClassInstance("this", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.Equals(this, obj, crystal: null);");
                    }
                    sb.AppendLine();

                    sb.AppendLine($"public override int GetHashCode() => {CommonClassInstance("this", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.GetHashCode(this);");
                    sb.AppendLine();
                }
            }
        }

        private async Task GenerateEqualsMixIn(StructuredStringBuilder sb)
        {
            if (IsGeneric)
            {
                using (var args = new FunctionWrapper(sb,
                    $"public static bool Equals{GetGenericTypes(MaskType.Normal)}"))
                {
                    args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.IGetter));
                    args.Add($"this {Interface(getter: true, internalInterface: true)} item");
                    args.Add($"{Interface(getter: true, internalInterface: true)} rhs");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"return {CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.Equals"))
                    {
                        args.Add("lhs: item");
                        args.AddPassArg("rhs");
                        args.Add("crystal: null");
                    }
                }
                sb.AppendLine();

                using (var args = new FunctionWrapper(sb,
                    $"public static bool Equals{GetGenericTypes(MaskType.Normal, MaskType.Translation)}"))
                {
                    args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.IGetter, MaskType.Normal, MaskType.Translation));
                    args.Add($"this {Interface(getter: true, internalInterface: true)} item");
                    args.Add($"{Interface(getter: true, internalInterface: true)} rhs");
                    args.Add($"{Mask(MaskType.Translation)} equalsMask");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"return {CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.Equals"))
                    {
                        args.Add("lhs: item");
                        args.AddPassArg("rhs");
                        args.Add("crystal: equalsMask.GetCrystal()");
                    }
                }
                sb.AppendLine();
            }
            else
            {
                using (var args = new FunctionWrapper(sb,
                    $"public static bool Equals{GetGenericTypes(MaskType.Normal)}"))
                {
                    args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.IGetter));
                    args.Add($"this {Interface(getter: true, internalInterface: true)} item");
                    args.Add($"{Interface(getter: true, internalInterface: true)} rhs");
                    args.Add($"{Mask(MaskType.Translation)}? equalsMask = null");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"return {CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class)}.Equals"))
                    {
                        args.Add("lhs: item");
                        args.AddPassArg("rhs");
                        args.Add("crystal: equalsMask?.GetCrystal()");
                    }
                }
                sb.AppendLine();
            }
        }

        protected virtual void GenerateEqualsCommon(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.IGetter, CommonGenerics.Class)) return;
            using (new RegionWrapper(sb, "Equals and Hash"))
            {
                using (var args = new FunctionWrapper(sb, $"public virtual bool Equals"))
                {
                    args.Add($"{Interface(getter: true, internalInterface: true)}? lhs");
                    args.Add($"{Interface(getter: true, internalInterface: true)}? rhs");
                    args.Add($"{nameof(TranslationCrystal)}? crystal");
                }
                using (sb.CurlyBrace())
                {
                    sb.AppendLine("if (!EqualsMaskHelper.RefEquality(lhs, rhs, out var isEqual)) return isEqual;");
                    if (HasLoquiBaseObject)
                    {
                        sb.AppendLine($"if (!base.Equals(({BaseClass.Interface(getter: true, internalInterface: true)})lhs, ({BaseClass.Interface(getter: true, internalInterface: true)})rhs, crystal)) return false;");
                    }
                    foreach (var field in IterateFields())
                    {
                        if (!HasKeyField() || field.KeyField)
                        {
                            var lhsAccessor = Accessor.FromType(field, "lhs");
                            var rhsAccessor = Accessor.FromType(field, "rhs");
                            if (field.IntegrateField)
                            {
                                field.GenerateForEquals(sb, lhsAccessor, rhsAccessor, "crystal");
                            }
                            else
                            {
                                field.GenerateForEquals(sb, lhsAccessor, rhsAccessor, "crystal");
                            }
                        }
                    }
                    sb.AppendLine("return true;");
                }
                sb.AppendLine();

                foreach (var baseObj in BaseClassTrail())
                {
                    using (var args = new FunctionWrapper(sb,
                        $"public override bool Equals"))
                    {
                        args.Add($"{baseObj.Interface(getter: true, internalInterface: true)}? lhs");
                        args.Add($"{baseObj.Interface(getter: true, internalInterface: true)}? rhs");
                        args.Add($"{nameof(TranslationCrystal)}? crystal");
                    }
                    using (sb.CurlyBrace())
                    {
                        using (var args = new ArgsWrapper(sb,
                            "return Equals"))
                        {
                            args.Add($"lhs: ({Interface(getter: true, internalInterface: true)}?)lhs");
                            args.Add($"rhs: rhs as {Interface(getter: true, internalInterface: true)}");
                            args.AddPassArg($"crystal");
                        }
                    }
                    sb.AppendLine();
                }

                using (var args = new FunctionWrapper(sb, $"public virtual int GetHashCode"))
                {
                    args.Add($"{Interface(getter: true, internalInterface: true)} item");
                }
                using (sb.CurlyBrace())
                {
                    sb.AppendLine("var hash = new HashCode();");
                    foreach (var field in IterateFields())
                    {
                        var itemAccessor = Accessor.FromType(field, "item");
                        if (!HasKeyField() || field.KeyField)
                        {
                            field.GenerateForHash(sb, itemAccessor, "hash");
                        }
                    }
                    if (HasLoquiBaseObject)
                    {
                        sb.AppendLine($"hash.Add(base.GetHashCode());");
                    }
                    sb.AppendLine("return hash.ToHashCode();");
                }
                sb.AppendLine();

                foreach (var baseObj in BaseClassTrail())
                {
                    using (var args = new FunctionWrapper(sb,
                        $"public override int GetHashCode"))
                    {
                        args.Add($"{baseObj.Interface(getter: true, internalInterface: true)} item");
                    }
                    using (sb.CurlyBrace())
                    {
                        using (var args = new ArgsWrapper(sb,
                            "return GetHashCode"))
                        {
                            args.Add($"item: ({Interface(getter: true, internalInterface: true)})item");
                        }
                    }
                    sb.AppendLine();
                }
            }
            sb.AppendLine();
        }

        public bool SupportsCopy()
        {
            return true;
        }

        private async Task GenerateCreateNew(StructuredStringBuilder sb)
        {
            using (var args = new FunctionWrapper(sb,
                $"internal static{NewOverride()}{ObjectName} GetNew"))
            {
            }
            using (sb.CurlyBrace())
            {
                if (Abstract)
                {
                    sb.AppendLine($"throw new ArgumentException(\"New called on an abstract class.\");");
                }
                else
                {
                    sb.AppendLine($"return new {ObjectName}();");
                }
            }
            sb.AppendLine();
        }

        private async Task GenerateCreateNewBasicCommon(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.IGetter, CommonGenerics.Class)) return;
            using (var args = new FunctionWrapper(sb,
                $"public{FunctionOverride()}object GetNew{GetGenericTypesNickname("_Setter", MaskType.Normal)}"))
            {
                if (IsTopClass)
                {
                    args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.ISetter, nickname: "_Setter"));
                }
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"return {Name}{GetGenericTypesNickname("_Setter", MaskType.Normal)}.GetNew();");
            }
            sb.AppendLine();
        }

        public async Task GenerateToStringCode(StructuredStringBuilder sb)
        {
            using (new RegionWrapper(sb, "To String"))
            {
                if (GenerateToString)
                {
                    sb.AppendLine($"public override string ToString()");
                    using (sb.CurlyBrace())
                    {
                        using (var args = new ArgsWrapper(sb,
                            $"return {MixInClassName}.ToString"))
                        {
                            args.Add("item: this");
                        }
                    }
                    sb.AppendLine();
                }
                sb.AppendLine();

                using (var args = new FunctionWrapper(sb,
                    $"public{FunctionOverride()}void ToString"))
                {
                    args.Add($"{nameof(StructuredStringBuilder)} sb");
                    args.Add($"string? name = null");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        $"{MixInClassName}.ToString"))
                    {
                        args.Add("item: this");
                        args.AddPassArg("sb");
                        args.AddPassArg("name");
                    }
                }
                sb.AppendLine();
            }
        }

        private async Task GenerateModules(StructuredStringBuilder sb)
        {
            foreach (var transl in gen.GenerationModules)
            {
                using (new RegionWrapper(sb, transl.RegionString))
                {
                    await transl.GenerateInClass(this, sb);
                    if (!IsGeneric)
                    {
                        await transl.GenerateInNonGenericClass(this, sb);
                    }
                }
            }
        }

        private void GenerateInterfacesInClass(StructuredStringBuilder sb)
        {
            if (GenerationInterfaces.Count > 0)
            {
                foreach (var interf in gen.GenerationInterfaces)
                {
                    using (new RegionWrapper(sb, interf.RegionString))
                    {
                        interf.GenerateInClass(this, sb);
                    }
                }
            }
        }

        public virtual void GenerateCopy(StructuredStringBuilder sb, MaskTypeSet maskTypeSet)
        {
            if (!maskTypeSet.Applicable(LoquiInterfaceType.ISetter, CommonGenerics.Class)) return;
            if (!SupportsCopy()) return;
            using (var args = new FunctionWrapper(sb,
                $"public{NewOverride(o => o.SupportsCopy())}{ObjectName} Copy{GetGenericTypes(MaskType.Copy)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, maskTypes: MaskType.Copy));
                args.Add($"{ObjectName} item");
                args.Add($"{Mask(MaskType.Copy)} copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                if (Abstract)
                {
                    sb.AppendLine($"{ObjectName} ret = ({ObjectName})System.Activator.CreateInstance(item.GetType());");
                }
                else
                {
                    sb.AppendLine($"{ObjectName} ret = GetNew();");
                }
                using (var args = new ArgsWrapper(sb,
                    $"ret.CopyIn{GetGenericTypes(MaskType.Normal, MaskType.Copy)}"))
                {
                    args.Add("item");
                    args.Add("copyMask: copyMask");
                }
                sb.AppendLine("return ret;");
            }
            sb.AppendLine();
        }

        public void GenerateCopyMixIn(StructuredStringBuilder sb)
        {
            if (!SupportsCopy()) return;
            using (var args = new FunctionWrapper(sb,
                $"public static {ObjectName} Copy{GetGenericTypes(MaskType.Normal, MaskType.Copy)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.Copy));
                args.Add($"this {ObjectName} item");
                args.Add($"{Mask(MaskType.Copy)} copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"return {CommonClassInstance("item", LoquiInterfaceType.ISetter, CommonGenerics.Class)}.Copy"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("copyMask");
                }
            }
            sb.AppendLine();
        }

        public virtual void GenerateDeepCopy(StructuredStringBuilder sb, MaskTypeSet maskTypeSet)
        {
            if (!maskTypeSet.Applicable(LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Normal, MaskType.Translation)) return;
            if (!SupportsCopy()) return;
            using (var args = new FunctionWrapper(sb,
                $"public {ObjectName} DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter, MaskType.Translation));
                args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} item");
                args.Add($"{Mask(MaskType.Translation)}? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{ObjectName} ret = ({ObjectName}){CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class, MaskType.NormalGetter)}.GetNew{GetGenericTypes(MaskType.Normal)}();");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("ret", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                {
                    args.Add("item: ret");
                    args.Add("rhs: item");
                    args.Add("errorMask: null");
                    args.Add($"copyMask: copyMask?.GetCrystal()");
                    args.Add($"deepCopy: true");
                }
                sb.AppendLine("return ret;");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public {ObjectName} DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation));
                args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} item");
                args.Add($"out {Mask(MaskType.Error)} errorMask");
                args.Add($"{Mask(MaskType.Translation)}? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"var errorMaskBuilder = new ErrorMaskBuilder();");
                sb.AppendLine($"{ObjectName} ret = ({ObjectName}){CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class, MaskType.NormalGetter)}.GetNew{GetGenericTypes(MaskType.Normal)}();");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("ret", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                {
                    args.Add("ret");
                    args.Add("item");
                    args.Add("errorMask: errorMaskBuilder");
                    args.Add("copyMask: copyMask?.GetCrystal()");
                    args.Add("deepCopy: true");
                }
                sb.AppendLine($"errorMask = {Mask(MaskType.Error)}.Factory(errorMaskBuilder);");
                sb.AppendLine("return ret;");
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public {ObjectName} DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                args.Add($"{Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} item");
                args.Add($"ErrorMaskBuilder? errorMask");
                args.Add($"TranslationCrystal? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{ObjectName} ret = ({ObjectName}){CommonClassInstance("item", LoquiInterfaceType.IGetter, CommonGenerics.Class, MaskType.NormalGetter)}.GetNew{GetGenericTypes(MaskType.Normal)}();");
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("ret", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.Translation)}.DeepCopyIn{GenerateGenericClause(GenericTypes_Nickname(MaskType.Normal), GenericTypes_Nickname(MaskType.NormalGetter))}"))
                {
                    args.Add("item: ret");
                    args.Add("rhs: item");
                    args.AddPassArg("errorMask");
                    args.AddPassArg("copyMask");
                    args.Add($"deepCopy: true");
                }
                sb.AppendLine("return ret;");
            }
            sb.AppendLine();
        }

        public void GenerateDeepCopyMixIn(StructuredStringBuilder sb)
        {
            if (!SupportsCopy()) return;
            using (var args = new FunctionWrapper(sb,
                $"public static {ObjectName} DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter, MaskType.Translation));
                args.Add($"this {Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} item");
                args.Add($"{Mask(MaskType.Translation)}? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"return {CommonClassInstance("item", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.NormalGetter, MaskType.Translation)}.DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Translation)}"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("copyMask");
                }
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public static {ObjectName} DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation));
                args.Add($"this {Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} item");
                args.Add($"out {Mask(MaskType.Error)} errorMask");
                args.Add($"{Mask(MaskType.Translation)}? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"return {CommonClassInstance("item", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.NormalGetter, MaskType.Translation)}.DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter, MaskType.Error, MaskType.Translation)}"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("copyMask");
                    args.Add("errorMask: out errorMask");
                }
            }
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public static {ObjectName} DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
            {
                args.Wheres.AddRange(GenericTypeMaskWheres(LoquiInterfaceType.ISetter, MaskType.Normal, MaskType.NormalGetter));
                args.Add($"this {Interface(GetGenericTypes(MaskType.NormalGetter), getter: true, internalInterface: true)} item");
                args.Add($"ErrorMaskBuilder? errorMask");
                args.Add($"TranslationCrystal? copyMask = null");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"return {CommonClassInstance("item", LoquiInterfaceType.ISetter, CommonGenerics.Functions, MaskType.NormalGetter, MaskType.Translation)}.DeepCopy{GetGenericTypes(MaskType.Normal, MaskType.NormalGetter)}"))
                {
                    args.AddPassArg("item");
                    args.AddPassArg("copyMask");
                    args.AddPassArg("errorMask");
                }
            }
            sb.AppendLine();
        }

        protected virtual async Task GenerateClearMixIn(StructuredStringBuilder sb)
        {
            using (var args = new FunctionWrapper(sb,
                $"public static void Clear{GetGenericTypes(MaskType.Normal)}"))
            {
                args.Wheres.AddRange(GenerateWhereClauses(LoquiInterfaceType.ISetter));
                args.Add($"this {Interface(internalInterface: true)} item");
            }
            using (sb.CurlyBrace())
            {
                using (var args = new ArgsWrapper(sb,
                    $"{CommonClassInstance("item", LoquiInterfaceType.ISetter, CommonGenerics.Class)}.Clear"))
                {
                    args.AddPassArg("item");
                }
            }
            sb.AppendLine();
        }

        protected void GenerateClear(StructuredStringBuilder sb)
        {
            using (var args = new FunctionWrapper(sb,
                $"void {nameof(IClearable)}.Clear"))
            {
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{CommonClassInstance("this", LoquiInterfaceType.ISetter, CommonGenerics.Class)}.Clear(this);");
            }
            sb.AppendLine();
        }

        protected virtual async Task GenerateClearCommon(StructuredStringBuilder sb, MaskTypeSet maskTypes)
        {
            if (!maskTypes.Applicable(LoquiInterfaceType.ISetter, CommonGenerics.Class)) return;
            sb.AppendLine("partial void ClearPartial();");
            sb.AppendLine();

            using (var args = new FunctionWrapper(sb,
                $"public{Virtual()}void Clear"))
            {
                args.Add($"{Interface(internalInterface: true)} item");
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"ClearPartial();");
                foreach (var field in IterateFields())
                {
                    if (field.ReadOnly) continue;
                    if (field.CustomClear)
                    {
                        sb.AppendLine($"{field.Name}CustomClear(item);");
                    }
                    else
                    {
                        field.GenerateClear(sb, Accessor.FromType(field, "item"));
                    }
                }
                if (HasLoquiBaseObject)
                {
                    sb.AppendLine($"base.Clear(item);");
                }
            }
            sb.AppendLine();

            foreach (var baseObj in BaseClassTrail())
            {
                using (var args = new FunctionWrapper(sb,
                    $"public override void Clear"))
                {
                    args.Add($"{baseObj.Interface(internalInterface: true)} item");
                }
                using (sb.CurlyBrace())
                {
                    using (var args = new ArgsWrapper(sb,
                        "Clear"))
                    {
                        args.Add($"item: ({Interface(internalInterface: true)})item");
                    }
                }
                sb.AppendLine();
            }

            foreach (var field in Fields)
            {
                if (!field.CustomClear) continue;
                using (var args = new ArgsWrapper(sb,
                    $"void {field.Name}CustomClear"))
                {
                    args.Add($"{Interface(internalInterface: true)} item");
                }
            }
        }

        protected virtual void GenerateGenericCreate(StructuredStringBuilder sb)
        {
            if (!Abstract)
            {
                sb.AppendLine($"public{NewOverride()}static {ObjectName} {Loqui.Internal.Constants.CREATE_FUNC_NAME}(IEnumerable<KeyValuePair<ushort, object>> fields)");
                using (sb.CurlyBrace())
                {
                    sb.AppendLine($"var ret = new {ObjectName}();");
                    sb.AppendLine($"foreach (var pair in fields)");
                    using (sb.CurlyBrace())
                    {
                        sb.AppendLine($"CopyInInternal_{Name}(ret, pair);");
                    }
                    sb.AppendLine("return ret;");
                }
                sb.AppendLine();
            }

            sb.AppendLine($"protected{NewOverride()}static void CopyInInternal_{Name}({ObjectName} obj, KeyValuePair<ushort, object> pair)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"if (!EnumExt.TryParse(pair.Key, out {FieldIndexName} enu))");
                using (sb.CurlyBrace())
                {
                    if (HasLoquiBaseObject)
                    {
                        sb.AppendLine($"CopyInInternal_{BaseClass.Name}(obj, pair);");
                    }
                    else
                    {
                        sb.AppendLine("throw new ArgumentException($\"Unknown index: {pair.Key}\");");
                    }
                }
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    foreach (var field in IterateFields())
                    {
                        if (field.Derivative) continue;
                        if (field.IntegrateField)
                        {
                            sb.AppendLine($"case {field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb, doIt: field.IntegrateField))
                        {
                            field.GenerateSetNth(
                                sb,
                                accessor: $"obj.{field.Name}",
                                rhs: $"({field.TypeName(getter: false)})pair.Value",
                                internalUse: true);
                        }
                    }
                    sb.AppendLine("default:");
                    using (new DepthWrapper(sb))
                    {
                        sb.AppendLine("throw new ArgumentException($\"Unknown enum type: {enu}\");");
                    }
                }
            }

            if (GenerateNthReflections)
            {
                sb.AppendLine($"public static void {Loqui.Internal.Constants.COPYIN_FUNC_NAME}(IEnumerable<KeyValuePair<ushort, object>> fields, {ObjectName} obj)");
                using (sb.CurlyBrace())
                {
                    sb.AppendLine("ILoquiObjectExt.CopyFieldsIn(obj, fields, skipProtected: false);");
                }
                sb.AppendLine();
            }
        }

        private void GenerateIsProtected(StructuredStringBuilder sb)
        {
            sb.AppendLine("public static bool IsProtected(ushort index)");
            using (sb.CurlyBrace())
            {
                sb.AppendLine($"{FieldIndexName} enu = ({FieldIndexName})index;");
                sb.AppendLine("switch (enu)");
                using (sb.CurlyBrace())
                {
                    var trues = IterateFieldIndices().Where((i) => i.Field.ReadOnly);
                    var falses = IterateFieldIndices().Where((i) => !i.Field.ReadOnly);
                    if (trues.Any())
                    {
                        foreach (var item in trues)
                        {
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return true;");
                        }
                    }
                    if (falses.Any())
                    {
                        foreach (var item in falses)
                        {
                            if (!item.Field.IntegrateField || !item.Field.Enabled) continue;
                            sb.AppendLine($"case {item.Field.IndexEnumName}:");
                        }
                        using (new DepthWrapper(sb))
                        {
                            sb.AppendLine("return false;");
                        }
                    }

                    GenerateStandardRegistrationDefault(sb, "IsProtected", "index", true);
                }
            }
            sb.AppendLine();
        }
        #endregion

        private async Task GenerateTranslations(StructuredStringBuilder sb)
        {
            if (gen.GenerationModules.Count == 0) return;
            using (new RegionWrapper(sb, "Modules"))
            {
                foreach (var translGen in gen.GenerationModules)
                {
                    using (new RegionWrapper(sb, translGen.RegionString))
                    {
                        await translGen.GenerateInVoid(this, sb);
                    }
                }
            }

            await Task.WhenAll(gen.GenerationModules
                .Select((g) => g.MiscellaneousGenerationActions(this)));
        }

        private async Task GenerateNonGenericClass(StructuredStringBuilder sb)
        {
            if (!IsGeneric) return;
            StructuredStringBuilder subGen = new StructuredStringBuilder();
            foreach (var translGen in gen.GenerationModules)
            {
                using (new RegionWrapper(sb, translGen.RegionString))
                {
                    await translGen.GenerateInNonGenericClass(this, subGen);
                }
            }

            if (subGen.Count == 0) return;

            using var ns = new NamespaceWrapper(sb, Namespace, fileScoped: false);
            using (var args = new ClassWrapper(sb, Name))
            {
                args.Static = true;
            }
            using (sb.CurlyBrace())
            {
                sb.AppendLines(subGen);
            }
        }

        private void GenerateLoquiInterfaces(StructuredStringBuilder sb)
        {
            if (gen.GenerationModules.Count == 0) return;
            using (new RegionWrapper(sb, "Loqui Interfaces"))
            {
                foreach (var interfGen in GenerationInterfaces)
                {
                    using (new RegionWrapper(sb, interfGen.RegionString))
                    {
                        interfGen.Generate(this, sb);
                    }
                }
            }
        }

        public bool HasLoquiInterface<T>()
            where T : GenerationInterface
        {
            return GenerationInterfaces.Any((i) => i.GetType().Equals(typeof(T)));
        }

        public string GetMaskString(string t, bool addClassName = true)
        {
            if (t.Equals("Exception"))
            {
                return Mask(MaskType.Error);
            }
            else
            {
                return $"{(addClassName ? $"{Name}." : null)}Mask<{t}>";
            }
        }

        public virtual async Task Resolve()
        {
            foreach (var gen in Generics.Values)
            {
                gen.Resolve(this);
            }

            await Task.WhenAll(IterateFields().ToList().Select((f) => f.Resolve()));

            if (HasLoquiBaseObject)
            {
                AddBaseClassNamespaces(this);

                foreach (var baseGen in BaseClass.Generics)
                {
                    if (Generics.TryGetValue(baseGen.Key, out var existing))
                    {
                        if (!existing.Override)
                        {
                            throw new ArgumentException("Generic added with the same name that was not marked as override.");
                        }
                    }
                    else
                    {
                        Generics.Add(baseGen.Key, baseGen.Value.Copy());
                    }
                    BaseGenerics[baseGen.Key] = baseGen.Key;
                }

                foreach (var baseGeneric in Node.Elements(XName.Get("BaseGeneric", LoquiGenerator.Namespace)))
                {
                    var genName = baseGeneric.GetAttribute("name");
                    var whereElem = baseGeneric.Elements(XName.Get("Where", LoquiGenerator.Namespace)).ToArray();
                    var definedElem = baseGeneric.Element(XName.Get("Defined", LoquiGenerator.Namespace));
                    if (whereElem.Any()
                        && definedElem != null)
                    {
                        throw new ArgumentException("Cannot define both Where and Defined nodes.");
                    }
                    if (whereElem.Any())
                    {
                        BaseGenerics[genName] = genName;
                        Generics[genName].Add(whereElem.Select((w) => w.Value));
                    }
                    else if (definedElem != null)
                    {
                        BaseGenerics[genName] = definedElem.Value;
                        Generics.Remove(genName);
                    }
                    else
                    {
                        throw new ArgumentException("Need to define Where or Defined node.");
                    }
                }
            }

            await Task.WhenAll(this.gen.GenerationModules.Select((mod) => mod.Resolve(this)));

            await Task.WhenAll(Interfaces.Select((interf) => interf.Resolve(this)));
        }

        private void AddBaseClassNamespaces(ObjectGeneration obj)
        {
            if (!obj.HasLoquiBaseObject) return;
            RequiredNamespaces.Add(obj.BaseClass.Namespace);
            AddBaseClassNamespaces(obj.BaseClass);
        }

        public void RegenerateAndStampSourceXML()
        {
            XDocument doc;
            using (var stream = new FileStream(SourceXMLFile.Path, FileMode.Open))
            {
                doc = XDocument.Load(stream);
            }
            bool modified = false;

            var LoquiNode = doc.Element(XName.Get("Loqui", LoquiGenerator.Namespace));
            foreach (var obj in LoquiNode.Elements(XName.Get("Object", LoquiGenerator.Namespace))
                .And(LoquiNode.Elements(XName.Get("Struct", LoquiGenerator.Namespace))))
            {
                var name = obj.GetAttribute("name");
                if (name.Equals(Name))
                {
                    if (obj.GetAttribute("GUID") == null)
                    {
                        var guidAttr = new XAttribute("GUID", GUID.ToString());
                        obj.Add(guidAttr);
                        modified = true;
                    }
                    if (obj.GetAttribute("ID") == null)
                    {
                        var guidAttr = new XAttribute("ID", ID.ToString());
                        obj.Add(guidAttr);
                        modified = true;
                    }
                    break;
                }
            }

            if (!modified) return;

            using (var xmlWriter = new XmlTextWriter(new FileStream(SourceXMLFile.Path, FileMode.Create), Encoding.ASCII))
            {
                xmlWriter.Formatting = Formatting.Indented;
                xmlWriter.Indentation = 2;
                doc.WriteTo(xmlWriter);
            }
            using var streamWriter = File.AppendText(SourceXMLFile.Path);
            streamWriter.Write(Environment.NewLine);
        }

        public string Mask_Specified(MaskType type, GenericSpecification specifications, bool addClassName = true)
        {
            return $"{(addClassName ? $"{Name}." : null)}{Mask_BasicName(type)}{GenerateGenericClause(GenericTypes_Nickname(type, specifications.Specifications.ToArray()))}";
        }

        public string MaskNickname(string name, MaskType maskType)
        {
            switch (maskType)
            {
                case MaskType.Normal:
                    return name;
                case MaskType.NormalGetter:
                    return $"{name}Getter";
                case MaskType.Error:
                    return $"{name}_{MaskModule.ErrMaskNickname}";
                case MaskType.Copy:
                    return $"{name}_{MaskModule.CopyMaskNickname}";
                case MaskType.Translation:
                    return $"{name}_{MaskModule.TranslationMaskNickname}";
                default:
                    throw new NotImplementedException();
            }
        }

        public string SpecifyGeneric(MaskType maskType, KeyValuePair<string, GenericDefinition> g, params KeyValuePair<string, string>[] specifications)
        {
            var specification = specifications.FirstOrDefault((spec) => spec.Key == g.Key);
            if (specification.Value == null)
            {
                return MaskNickname(g.Key, maskType);
            }
            else
            {
                var nameKey = ObjectNamedKey.Factory(specification.Value, ProtoGen.Protocol);
                if (!ProtoGen.Gen.ObjectGenerationsByObjectNameKey.TryGetValue(
                   nameKey,
                   out var targetObj))
                {
                    throw new ArgumentException($"{nameKey} can not be located.");
                }
                return targetObj.Mask(maskType);
            }
        }

        public IEnumerable<string> GenericTypes_Nickname(MaskType maskType, params KeyValuePair<string, string>[] specifications)
        {
            return Generics
                .Where(g => g.Value.Loqui)
                .Select((g) =>
                {
                    return SpecifyGeneric(maskType, g, specifications);
                });
        }

        public IEnumerable<string> BaseGenericTypes_Nickname(MaskType maskType, params KeyValuePair<string, string>[] specifications)
        {
            return Generics
                .Where((g) => g.Value.BaseObjectGeneration != null)
                .Where((g) => BaseGenerics.ContainsKey(g.Key))
                .Select((g) =>
                {
                    return SpecifyGeneric(maskType, g, specifications);
                });
        }

        public string Mask_BasicName(MaskType type)
        {
            switch (type)
            {
                case MaskType.Normal:
                    return $"Mask";
                case MaskType.Error:
                    return $"ErrorMask";
                case MaskType.Copy:
                    return $"CopyMask";
                case MaskType.Translation:
                    return $"TranslationMask";
                default:
                    throw new NotImplementedException();
            }
        }

        public string Mask(MaskType type, bool addClassName = true)
        {
            switch (type)
            {
                case MaskType.Error:
                    return $"{(addClassName ? $"{Name}." : null)}{Mask_BasicName(MaskType.Error)}{GetGenericTypes(MaskType.Error)}";
                case MaskType.Copy:
                    return $"{(addClassName ? $"{Name}." : null)}{Mask_BasicName(MaskType.Copy)}{GetGenericTypes(MaskType.Copy)}";
                case MaskType.Translation:
                    return $"{(addClassName ? $"{Name}." : null)}{Mask_BasicName(MaskType.Translation)}{GetGenericTypes(MaskType.Translation)}";
                case MaskType.Normal:
                default:
                    throw new NotImplementedException();
            }
        }

        public bool CanAssume()
        {
            return !Generics.Any(g => g.Value.Loqui && g.Value.BaseObjectGeneration == null);
        }

        public IEnumerable<string> GenericTypes_Assumed(MaskType type, bool onlyAssumeSubclass = false)
        {
            return Generics
                .Where(g => g.Value.Loqui)
                .Select((g) =>
                {
                    if (g.Value.BaseObjectGeneration != null)
                    {
                        if (!onlyAssumeSubclass || !BaseGenerics.ContainsKey(g.Key))
                        {
                            return g.Value.BaseObjectGeneration.Mask(type);
                        }
                        else
                        {
                            return SpecifyGeneric(type, g);
                        }
                    }
                    else
                    {
                        switch (type)
                        {
                            case MaskType.Error:
                                return nameof(ErrorMaskPlaceholder);
                            case MaskType.Copy:
                            case MaskType.Normal:
                            default:
                                throw new NotImplementedException();
                        }
                    }
                });
        }

        public string GenericClause_Assumed(MaskType type, bool onlyAssumeSubclass = false)
        {
            return GenerateGenericClause(GenericTypes_Assumed(type, onlyAssumeSubclass));
        }

        public string Mask_GenericAssumed(MaskType type, bool onlyAssumeSubclass = false)
        {
            return $"{Mask_BasicName(type)}{GenericClause_Assumed(type, onlyAssumeSubclass)}";
        }

        public string Mask_Unspecified(MaskType type)
        {
            return $"{Name}.{Mask_BasicName(type)}{GenerateGenericClause(Generics.Where((g) => g.Value.BaseObjectGeneration != null || g.Value.Loqui).Select((g) => string.Empty))}";
        }

        public string BaseMask_GenericClausesAssumed(MaskType type)
        {
            return GenerateGenericClause(Generics.SelectWhere((g) =>
            {
                if (g.Value.BaseObjectGeneration != null)
                {
                    return TryGet<string>.Succeed(g.Value.BaseObjectGeneration.Mask(type));
                }
                else if (g.Value.Loqui)
                {
                    return TryGet<string>.Succeed("IErrorMask");
                }
                else
                {
                    return TryGet<string>.Failure;
                }
            }));
        }

        public string GetBaseMask_GenericTypes(MaskType type)
        {
            if (!HasLoquiBaseObject)
            {
                return GetGenericTypes(type);
            }
            return GenerateGenericClause(Generics
                .Where((g) => g.Value.Loqui)
                .Where((g) => BaseGenerics.ContainsKey(g.Key))
                .Select((g) =>
                {
                    return SpecifyGeneric(type, g);
                }));
        }

        public IEnumerable<TypeGeneration> IterateFields(
            bool nonIntegrated = false,
            SetMarkerType.ExpandSets expandSets = SetMarkerType.ExpandSets.True,
            bool includeBaseClass = false)
        {
            return IterateFieldIndices(
                nonIntegrated: nonIntegrated,
                expandSets: expandSets,
                includeBaseClass: includeBaseClass).Select((f) => f.Field);
        }

        public IEnumerable<(int PublicIndex, int InternalIndex, TypeGeneration Field)> IterateFieldIndices(
            bool nonIntegrated = false,
            SetMarkerType.ExpandSets expandSets = SetMarkerType.ExpandSets.True,
            bool includeBaseClass = false)
        {
            if (includeBaseClass && HasLoquiBaseObject)
            {
                foreach (var item in BaseClass.IterateFieldIndices(
                    nonIntegrated: nonIntegrated,
                    expandSets: expandSets,
                    includeBaseClass: includeBaseClass))
                {
                    yield return item;
                }
            }
            int i = StartingIndex;
            int index = -1;
            for (int j = 0; j < Fields.Count; j++)
            {
                index++;
                var field = Fields[j];
                if (!field.Enabled) continue;
                if (!field.IntegrateField)
                {
                    if (field is SetMarkerType set)
                    {
                        switch (expandSets)
                        {
                            case SetMarkerType.ExpandSets.False:
                                continue;
                            case SetMarkerType.ExpandSets.FalseAndInclude:
                                yield return (-1, j, field);
                                continue;
                            case SetMarkerType.ExpandSets.True:
                            case SetMarkerType.ExpandSets.TrueAndInclude:
                                int k = 0;
                                foreach (var subField in set.IterateFields(
                                    nonIntegrated: nonIntegrated,
                                    expandSets: expandSets))
                                {
                                    yield return (subField.Index + i, j, subField.Field);
                                    k++;
                                }
                                i += k;
                                break;
                            default:
                                throw new NotImplementedException();
                        }
                        if (expandSets == SetMarkerType.ExpandSets.TrueAndInclude)
                        {
                            yield return (-1, index, field);
                        }
                    }
                    else if (nonIntegrated)
                    {
                        yield return (-1, index, field);
                    }
                }
                else
                {
                    yield return (i++, index, field);
                }
            }
        }

        public virtual async Task<OverrideType> GetFunctionOverrideType(Func<ClassGeneration, Task<bool>> tester)
        {
            return OverrideType.None;
        }

        public virtual OverrideType GetFunctionOverrideType()
        {
            return OverrideType.None;
        }

        public async Task<string> FunctionOverride(Func<ClassGeneration, Task<bool>> tester, bool prependSpace = true)
        {
            switch (await GetFunctionOverrideType(tester))
            {
                case OverrideType.None:
                    return prependSpace ? " " : string.Empty;
                case OverrideType.HasBase:
                    return $"{(prependSpace ? " " : null)}override ";
                case OverrideType.OnlyHasDerivative:
                    return $"{(prependSpace ? " " : null)}virtual ";
                default:
                    throw new NotImplementedException();
            }
        }

        public string FunctionOverride(bool doIt = true, bool prependSpace = true, OverrideType? overrideType = null)
        {
            if (!doIt) return " ";
            switch (overrideType ?? GetFunctionOverrideType())
            {
                case OverrideType.None:
                    return prependSpace ? " " : string.Empty;
                case OverrideType.HasBase:
                    return $"{(prependSpace ? " " : null)}override ";
                case OverrideType.OnlyHasDerivative:
                    return $"{(prependSpace ? " " : null)}virtual ";
                default:
                    throw new NotImplementedException();
            }
        }

        public async Task<string> FunctionOverride(bool doItOverride, Func<ClassGeneration, Task<bool>> tester, bool prependSpace = true)
        {
            if (doItOverride)
            {
                return FunctionOverride(prependSpace: prependSpace, overrideType: OverrideType.HasBase);
            }

            return await FunctionOverride(tester, prependSpace: prependSpace);
        }

        public virtual string Virtual(bool doIt = true)
        {
            return " ";
        }

        public IEnumerable<ClassGeneration> BaseClassTrail()
        {
            if (!HasLoquiBaseObject) yield break;
            yield return BaseClass;
            foreach (var ret in BaseClass.BaseClassTrail())
            {
                yield return ret;
            }
        }

        public async Task<IEnumerable<ObjectGeneration>> EntireClassTree()
        {
            var processedObjs = new HashSet<ObjectGeneration>();
            await EntireClassTree(processedObjs);
            return processedObjs;
        }

        private async Task EntireClassTree(HashSet<ObjectGeneration> processedObjs)
        {
            if (processedObjs.Contains(this)) return;
            processedObjs.Add(this);
            foreach (var subObj in await InheritingObjects())
            {
                await subObj.EntireClassTree(processedObjs);
            }
            if (HasLoquiBaseObject)
            {
                await BaseClass.EntireClassTree(processedObjs);
            }
        }

        public bool TestTrueAndNotBaseClass(Func<ObjectGeneration, bool> test)
        {
            return test(this) && !BaseClassTrail().Any(b => test(b));
        }

        public bool TestTrueForAnyInClassChain(Func<ObjectGeneration, bool> test)
        {
            return test(this) || BaseClassTrail().Any(b => test(b));
        }

        public override string ToString()
        {
            return $"{ProtoGen.Protocol.Namespace}.{Name}";
        }

        public void MarkFailure(Exception ex)
        {
            _directlyInheritingObjectsTcs.TrySetException(ex);
            LoadingCompleteTask.TrySetException(ex);
            WiredBaseClassTCS.TrySetException(ex);
        }

        public string[] GenericTypeMaskWheres(LoquiInterfaceType type, params MaskType[] maskTypes)
        {
            return maskTypes.SelectMany(
                (maskType) =>
                {
                    switch (maskType)
                    {
                        case MaskType.Normal:
                            return GenerateWhereClauses(type)
                                .Select(where =>
                                {
                                    return where;
                                });
                        case MaskType.NormalGetter:
                            return GenerateWhereClauses(
                                LoquiInterfaceType.IGetter,
                                Generics.SelectMany(kv =>
                                {
                                    if (!kv.Value.Loqui && maskTypes.Contains(MaskType.Normal))
                                    {
                                        return Enumerable.Empty<KeyValuePair<string, GenericDefinition>>();
                                    }
                                    return new KeyValuePair<string, GenericDefinition>(MaskNickname(kv.Key, MaskType.NormalGetter), kv.Value).AsEnumerable();
                                }));
                        default:
                            break;
                    }
                    return Generics
                        .SelectWhere((g) =>
                        {
                            List<string> strs = new List<string>();
                            if (g.Value.BaseObjectGeneration != null)
                            {
                                strs.Add($"{g.Value.BaseObjectGeneration.Mask(maskType)}");
                            }
                            else if (g.Value.Loqui)
                            {
                                strs.Add("class");
                            }
                            else
                            {
                                return TryGet<string>.Failure;
                            }
                            if (maskType == MaskType.Error)
                            {
                                strs.Add($"IErrorMask<{MaskNickname(g.Key, maskType)}>");
                            }
                            if (maskType == MaskType.Translation)
                            {
                                strs.Add($"{nameof(ITranslationMask)}");
                            }
                            return TryGet<string>.Succeed($"where {g.Key}_{MaskModule.MaskNickname(maskType)} : {(string.Join(", ", strs))}");
                        });
                }).ToArray();
        }

        public IEnumerable<IEnumerable<string>> GetGenericTypeStrings(MaskType[] maskTypes, GenericSpecification specification = null)
        {
            return maskTypes.Select(
                (maskType) =>
                {
                    switch (maskType)
                    {
                        case MaskType.Normal:
                            return Generics.Select((g) => g.Key).Select(specification.Swap);
                        case MaskType.NormalGetter:
                            return Generics.SelectMany((g) =>
                            {
                                if (g.Value.Loqui)
                                {
                                    return MaskNickname(g.Key, MaskType.NormalGetter).AsEnumerable();
                                }
                                if (maskTypes.Contains(MaskType.Normal))
                                {
                                    return Enumerable.Empty<string>();
                                }
                                else
                                {
                                    return g.Key.AsEnumerable();
                                }
                            }).Select(specification.Swap);
                        case MaskType.Error:
                        case MaskType.Copy:
                        case MaskType.Translation:
                            return GenericTypes_Nickname(maskType).Select(specification.Swap);
                        default:
                            throw new NotImplementedException();
                    }
                });
        }

        public string GetGenericTypes(params MaskType[] maskTypes)
        {
            return GenerateGenericClause(GetGenericTypeStrings(maskTypes, null).ToArray());
        }

        public string GetGenericTypes(MaskType[] maskTypes, GenericSpecification specification)
        {
            return GenerateGenericClause(GetGenericTypeStrings(maskTypes, specification).ToArray());
        }

        public string GetGenericTypes(MaskType maskType, GenericSpecification specification = null)
        {
            return GenerateGenericClause(GetGenericTypeStrings(maskType.AsEnumerable().ToArray(), specification).ToArray());
        }

        public string GetGenericTypes(MaskType maskType, params string[] extraGenerics)
        {
            return GenerateGenericClause(GetGenericTypeStrings(maskType.AsEnumerable().ToArray(), null).And(extraGenerics).ToArray());
        }

        public string GetGenericTypes(MaskType maskType, GenericSpecification specification, params string[] extraGenerics)
        {
            return GenerateGenericClause(GetGenericTypeStrings(maskType.AsEnumerable().ToArray(), specification).And(extraGenerics).ToArray());
        }

        public string GetGenericTypesNickname(string nickName, params MaskType[] maskTypes)
        {
            return GenerateGenericClause(
                maskTypes.Select(
                    (maskType) =>
                    {
                        switch (maskType)
                        {
                            case MaskType.Normal:
                                return Generics.Select((g) => $"{g.Key}{nickName}");
                            case MaskType.NormalGetter:
                                return Generics.Select((g) => $"{MaskNickname(g.Key, MaskType.NormalGetter)}{nickName}");
                            case MaskType.Error:
                            case MaskType.Copy:
                            case MaskType.Translation:
                                return GenericTypes_Nickname(maskType).Select(s => $"{s}{nickName}");
                            default:
                                throw new NotImplementedException();
                        }
                    }).ToArray());
        }

        public string GetBaseGenericTypes(params MaskType[] maskTypes)
        {
            return GenerateGenericClause(
                maskTypes.Select(
                    (maskType) =>
                    {
                        switch (maskType)
                        {
                            case MaskType.Normal:
                                return BaseGenerics.Select((g) => g.Key);
                            case MaskType.Error:
                            case MaskType.Copy:
                            case MaskType.Translation:
                                return BaseGenericTypes_Nickname(maskType);
                            default:
                                throw new NotImplementedException();
                        }
                    }).ToArray());
        }

        public string GetTypeName(LoquiInterfaceType type)
        {
            switch (type)
            {
                case LoquiInterfaceType.Direct:
                    return Name;
                case LoquiInterfaceType.IGetter:
                    return Interface(getter: true, internalInterface: true);
                case LoquiInterfaceType.ISetter:
                    return Interface(getter: false, internalInterface: true);
                default:
                    throw new NotImplementedException();
            }
        }

        public bool IsObjectInterface(string str)
        {
            if (Interface(getter: true, internalInterface: true).Equals(str)) return true;
            if (Interface(getter: true, internalInterface: false).Equals(str)) return true;
            if (Interface(getter: false, internalInterface: true).Equals(str)) return true;
            if (Interface(getter: false, internalInterface: false).Equals(str)) return true;
            return false;
        }

        public string Interface(bool getter = false, bool internalInterface = false, GenericSpecification specification = null)
        {
            return Interface(
                genericTypes: GetGenericTypes(MaskType.Normal, specification),
                getter: getter,
                internalInterface: internalInterface);
        }

        public string Interface(string genericTypes, bool getter = false, bool internalInterface = false)
        {
            var ret = InterfaceNoGenerics(
                getter: getter,
                internalInterface: internalInterface);
            return $"{ret}{genericTypes}";
        }

        public string Interface(MaskType[] maskTypes, bool getter = false, bool internalInterface = false, GenericSpecification specification = null)
        {
            if (maskTypes.Contains(MaskType.NormalGetter))
            {
                return Interface(
                    GetGenericTypes(MaskType.NormalGetter, specification),
                    getter: getter,
                    internalInterface: internalInterface);
            }
            else
            {
                return Interface(
                    getter: getter,
                    internalInterface: internalInterface,
                    specification: specification);
            }
        }

        public string InterfaceNoGenerics(bool getter = false, bool internalInterface = false)
        {
            return $"I{Name}{(internalInterface && ((getter && HasInternalGetInterface) || (!getter && HasInternalSetInterface)) ? "Internal" : null)}{(getter ? "Getter" : null)}";
        }

        public IAsyncEnumerable<string> GetApplicableInterfaces(LoquiInterfaceType type)
        {
            return gen.GenerationModules
                .ToAsyncEnumerable()
                .SelectMany((tr) => tr.Interfaces(this))
                .Where(i => i.Location == type)
                .Select(i => i.Interface);
        }

        private string GetEmptyGenerics(MaskType[] maskTypes)
        {
            if (maskTypes?.Length == 0)
            {
                return (Generics.Count > 0 ? $"<{string.Join(",", Generics.Select((g) => string.Empty))}>" : string.Empty);
            }

            string[] strs = maskTypes.Select(
                (maskType) =>
                {
                    switch (maskType)
                    {
                        case MaskType.Normal:
                            return Generics.Select((g) => g.Key);
                        case MaskType.Error:
                        case MaskType.Copy:
                        case MaskType.Translation:
                            return GenericTypes_Nickname(maskType);
                        default:
                            throw new NotImplementedException();
                    }
                })
                .SelectMany(s => s)
                .Select(s => string.Empty)
                .ToArray();
            return (strs.Length > 0 ? $"<{string.Join(",", strs)}>" : string.Empty);
        }
    }
}
